[{"filePath":"C:\\Users\\genco\\Desktop\\lavoro\\w4uN8N\\src\\App.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\genco\\Desktop\\lavoro\\w4uN8N\\src\\components\\AuthGuard.tsx","messages":[{"ruleId":"react-hooks/set-state-in-effect","severity":2,"message":"Error: Calling setState synchronously within an effect can trigger cascading renders\n\nEffects are intended to synchronize state between React and external systems such as manually updating the DOM, state management libraries, or other platform APIs. In general, the body of an effect should do one or both of the following:\n* Update external systems with the latest state from React.\n* Subscribe for updates from some external system, calling setState in a callback function when external state changes.\n\nCalling setState synchronously within an effect body causes cascading renders that can hurt performance, and is not recommended. (https://react.dev/learn/you-might-not-need-an-effect).\n\nC:\\Users\\genco\\Desktop\\lavoro\\w4uN8N\\src\\components\\AuthGuard.tsx:17:13\n  15 |         if (!loading) {\n  16 |             console.log(`[AuthGuard] Auth resolved ÔÇö user: ${user?.email ?? 'none'}, path: ${location.pathname}`);\n> 17 |             setTimedOut(false);\n     |             ^^^^^^^^^^^ Avoid calling setState() directly within an effect\n  18 |             return;\n  19 |         }\n  20 |","line":17,"column":13,"nodeType":null,"endLine":17,"endColumn":24}],"suppressedMessages":[],"errorCount":1,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import React, { useState, useEffect } from 'react';\r\nimport { Navigate, useLocation } from 'react-router-dom';\r\nimport { useAuth } from '../lib/auth';\r\nimport { AlertTriangle, RefreshCw } from 'lucide-react';\r\n\r\n// Timeout (in ms) after which we assume auth is stuck and show a fallback\r\nconst AUTH_TIMEOUT_MS = 10_000;\r\n\r\nconst AuthGuard: React.FC<{ children: React.ReactNode }> = ({ children }) => {\r\n    const { user, loading } = useAuth();\r\n    const location = useLocation();\r\n    const [timedOut, setTimedOut] = useState(false);\r\n\r\n    useEffect(() => {\r\n        if (!loading) {\r\n            console.log(`[AuthGuard] Auth resolved ÔÇö user: ${user?.email ?? 'none'}, path: ${location.pathname}`);\r\n            setTimedOut(false);\r\n            return;\r\n        }\r\n\r\n        console.log(`[AuthGuard] Waiting for auth to resolve (timeout: ${AUTH_TIMEOUT_MS}ms)...`);\r\n        const timer = setTimeout(() => {\r\n            if (loading) {\r\n                console.error(`[AuthGuard] Auth loading timed out after ${AUTH_TIMEOUT_MS}ms ÔÇö showing fallback`);\r\n                setTimedOut(true);\r\n            }\r\n        }, AUTH_TIMEOUT_MS);\r\n\r\n        return () => clearTimeout(timer);\r\n    }, [loading, user, location.pathname]);\r\n\r\n    // ÔöÇÔöÇÔöÇ Timeout Fallback ÔöÇÔöÇÔöÇÔöÇÔöÇÔöÇÔöÇÔöÇÔöÇÔöÇÔöÇÔöÇÔöÇÔöÇÔöÇÔöÇÔöÇÔöÇÔöÇÔöÇÔöÇÔöÇÔöÇÔöÇÔöÇÔöÇÔöÇÔöÇÔöÇÔöÇÔöÇÔöÇÔöÇÔöÇÔöÇÔöÇÔöÇÔöÇÔöÇÔöÇÔöÇÔöÇÔöÇÔöÇÔöÇÔöÇÔöÇÔöÇÔöÇÔöÇÔöÇÔöÇÔöÇÔöÇ\r\n    if (timedOut) {\r\n        return (\r\n            <div style={{\r\n                width: '100vw', height: '100vh',\r\n                display: 'flex', alignItems: 'center', justifyContent: 'center',\r\n                background: 'var(--bg-dark)', flexDirection: 'column', gap: '1.5rem',\r\n                padding: '2rem', textAlign: 'center'\r\n            }}>\r\n                <div style={{\r\n                    width: '64px', height: '64px', borderRadius: '50%',\r\n                    background: 'rgba(251, 191, 36, 0.1)',\r\n                    border: '2px solid #fbbf24',\r\n                    display: 'flex', alignItems: 'center', justifyContent: 'center'\r\n                }}>\r\n                    <AlertTriangle size={28} color=\"#fbbf24\" />\r\n                </div>\r\n                <h2 style={{ color: 'white', fontSize: '1.3rem' }}>\r\n                    Connessione lenta\r\n                </h2>\r\n                <p style={{\r\n                    color: 'var(--text-muted)', fontSize: '0.9rem',\r\n                    maxWidth: '360px', lineHeight: 1.6\r\n                }}>\r\n                    Non siamo riusciti a verificare la tua sessione.\r\n                    Controlla la connessione internet e riprova.\r\n                </p>\r\n                <button\r\n                    className=\"btn-primary\"\r\n                    onClick={() => {\r\n                        console.log('[AuthGuard] User clicked reload after timeout');\r\n                        window.location.reload();\r\n                    }}\r\n                    style={{ gap: '0.5rem', padding: '0.8rem 2rem' }}\r\n                >\r\n                    <RefreshCw size={16} /> Riprova\r\n                </button>\r\n            </div>\r\n        );\r\n    }\r\n\r\n    // ÔöÇÔöÇÔöÇ Loading ÔöÇÔöÇÔöÇÔöÇÔöÇÔöÇÔöÇÔöÇÔöÇÔöÇÔöÇÔöÇÔöÇÔöÇÔöÇÔöÇÔöÇÔöÇÔöÇÔöÇÔöÇÔöÇÔöÇÔöÇÔöÇÔöÇÔöÇÔöÇÔöÇÔöÇÔöÇÔöÇÔöÇÔöÇÔöÇÔöÇÔöÇÔöÇÔöÇÔöÇÔöÇÔöÇÔöÇÔöÇÔöÇÔöÇÔöÇÔöÇÔöÇÔöÇÔöÇÔöÇÔöÇÔöÇÔöÇÔöÇÔöÇÔöÇÔöÇÔöÇÔöÇÔöÇÔöÇ\r\n    if (loading) {\r\n        return (\r\n            <div style={{\r\n                width: '100vw', height: '100vh',\r\n                display: 'flex', alignItems: 'center', justifyContent: 'center',\r\n                background: 'var(--bg-dark)', flexDirection: 'column', gap: '1.5rem'\r\n            }}>\r\n                <div className=\"cyber-spinner\">\r\n                    <div className=\"spinner-ring\" />\r\n                    <div className=\"spinner-ring\" />\r\n                    <div className=\"spinner-core\" />\r\n                </div>\r\n                <p style={{\r\n                    color: 'var(--text-muted)', fontSize: '0.9rem',\r\n                    fontFamily: \"'Inter', sans-serif\"\r\n                }}>\r\n                    Caricamento sessione...\r\n                </p>\r\n            </div>\r\n        );\r\n    }\r\n\r\n    // ÔöÇÔöÇÔöÇ Not Authenticated ÔöÇÔöÇÔöÇÔöÇÔöÇÔöÇÔöÇÔöÇÔöÇÔöÇÔöÇÔöÇÔöÇÔöÇÔöÇÔöÇÔöÇÔöÇÔöÇÔöÇÔöÇÔöÇÔöÇÔöÇÔöÇÔöÇÔöÇÔöÇÔöÇÔöÇÔöÇÔöÇÔöÇÔöÇÔöÇÔöÇÔöÇÔöÇÔöÇÔöÇÔöÇÔöÇÔöÇÔöÇÔöÇÔöÇÔöÇÔöÇÔöÇÔöÇÔöÇÔöÇÔöÇ\r\n    if (!user) {\r\n        console.log(`[AuthGuard] No user ÔÇö redirecting to /login (from: ${location.pathname})`);\r\n        return <Navigate to=\"/login\" state={{ from: location }} replace />;\r\n    }\r\n\r\n    // ÔöÇÔöÇÔöÇ Authenticated ÔöÇÔöÇÔöÇÔöÇÔöÇÔöÇÔöÇÔöÇÔöÇÔöÇÔöÇÔöÇÔöÇÔöÇÔöÇÔöÇÔöÇÔöÇÔöÇÔöÇÔöÇÔöÇÔöÇÔöÇÔöÇÔöÇÔöÇÔöÇÔöÇÔöÇÔöÇÔöÇÔöÇÔöÇÔöÇÔöÇÔöÇÔöÇÔöÇÔöÇÔöÇÔöÇÔöÇÔöÇÔöÇÔöÇÔöÇÔöÇÔöÇÔöÇÔöÇÔöÇÔöÇÔöÇÔöÇÔöÇÔöÇ\r\n    return <>{children}</>;\r\n};\r\n\r\nexport default AuthGuard;\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\genco\\Desktop\\lavoro\\w4uN8N\\src\\components\\ErrorBoundary.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\genco\\Desktop\\lavoro\\w4uN8N\\src\\components\\LoadingOverlay.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\genco\\Desktop\\lavoro\\w4uN8N\\src\\components\\Sidebar.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\genco\\Desktop\\lavoro\\w4uN8N\\src\\components\\ui\\Toast.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\genco\\Desktop\\lavoro\\w4uN8N\\src\\context\\ToastContext.tsx","messages":[{"ruleId":"react-refresh/only-export-components","severity":2,"message":"Fast refresh only works when a file only exports components. Use a new file to share constants or functions between components.","line":69,"column":14,"nodeType":"Identifier","messageId":"namedExport","endLine":69,"endColumn":22}],"suppressedMessages":[],"errorCount":1,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import React, { createContext, useContext, useState, useCallback } from 'react';\r\nimport { AnimatePresence } from 'framer-motion';\r\nimport { Toast } from '../components/ui/Toast';\r\nimport type { ToastType } from '../components/ui/Toast';\r\n\r\ninterface ToastData {\r\n    id: string;\r\n    message: string;\r\n    type: ToastType;\r\n    duration?: number;\r\n}\r\n\r\ninterface ToastContextType {\r\n    addToast: (message: string, type: ToastType, duration?: number) => void;\r\n    success: (message: string, duration?: number) => void;\r\n    error: (message: string, duration?: number) => void;\r\n    info: (message: string, duration?: number) => void;\r\n    warning: (message: string, duration?: number) => void;\r\n}\r\n\r\nconst ToastContext = createContext<ToastContextType | undefined>(undefined);\r\n\r\nexport const ToastProvider: React.FC<{ children: React.ReactNode }> = ({ children }) => {\r\n    const [toasts, setToasts] = useState<ToastData[]>([]);\r\n\r\n    const removeToast = useCallback((id: string) => {\r\n        setToasts((prev) => prev.filter((toast) => toast.id !== id));\r\n    }, []);\r\n\r\n    const addToast = useCallback((message: string, type: ToastType, duration = 5000) => {\r\n        const id = Math.random().toString(36).substring(2, 9);\r\n        setToasts((prev) => [...prev, { id, message, type, duration }]);\r\n    }, []);\r\n\r\n    const success = useCallback((message: string, duration?: number) => addToast(message, 'success', duration), [addToast]);\r\n    const error = useCallback((message: string, duration?: number) => addToast(message, 'error', duration), [addToast]);\r\n    const info = useCallback((message: string, duration?: number) => addToast(message, 'info', duration), [addToast]);\r\n    const warning = useCallback((message: string, duration?: number) => addToast(message, 'warning', duration), [addToast]);\r\n\r\n    return (\r\n        <ToastContext.Provider value={{ addToast, success, error, info, warning }}>\r\n            {children}\r\n            <div\r\n                style={{\r\n                    position: 'fixed',\r\n                    bottom: '24px',\r\n                    right: '24px',\r\n                    display: 'flex',\r\n                    flexDirection: 'column',\r\n                    gap: '12px',\r\n                    zIndex: 9999,\r\n                    pointerEvents: 'none' // Allows clicking through the container area\r\n                }}\r\n            >\r\n                <AnimatePresence>\r\n                    {toasts.map((toast) => (\r\n                        <Toast\r\n                            key={toast.id}\r\n                            {...toast}\r\n                            onClose={removeToast}\r\n                        />\r\n                    ))}\r\n                </AnimatePresence>\r\n            </div>\r\n        </ToastContext.Provider>\r\n    );\r\n};\r\n\r\nexport const useToast = (): ToastContextType => {\r\n    const context = useContext(ToastContext);\r\n    if (!context) {\r\n        throw new Error('useToast must be used within a ToastProvider');\r\n    }\r\n    return context;\r\n};\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\genco\\Desktop\\lavoro\\w4uN8N\\src\\data\\genres.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\genco\\Desktop\\lavoro\\w4uN8N\\src\\data\\prompts.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\genco\\Desktop\\lavoro\\w4uN8N\\src\\layouts\\MainLayout.tsx","messages":[{"ruleId":"react-hooks/exhaustive-deps","severity":1,"message":"React Hook useEffect has a missing dependency: 'fetchActiveBookDetails'. Either include it or remove the dependency array.","line":41,"column":8,"nodeType":"ArrayExpression","endLine":41,"endColumn":22,"suggestions":[{"desc":"Update the dependencies array to be: [activeBookId, fetchActiveBookDetails]","fix":{"range":[1521,1535],"text":"[activeBookId, fetchActiveBookDetails]"}}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import React, { useEffect, useState } from 'react';\r\nimport { Outlet, useNavigate, useLocation } from 'react-router-dom';\r\nimport { motion } from 'framer-motion';\r\nimport { Loader2 } from 'lucide-react';\r\nimport Sidebar from '../components/Sidebar';\r\nimport { supabase } from '../lib/api';\r\nimport { getRouteByStatus } from '../lib/navigation';\r\n\r\ninterface Project {\r\n    id: string;\r\n    title: string;\r\n}\r\n\r\nconst MainLayout: React.FC = () => {\r\n    const navigate = useNavigate();\r\n    const location = useLocation();\r\n    const [projects, setProjects] = useState<Project[]>([]);\r\n    const [activeBookPages, setActiveBookPages] = useState<number | null>(null);\r\n    const [activeBookId, setActiveBookId] = useState<string | null>(localStorage.getItem('active_book_id'));\r\n    const [switching, setSwitching] = useState(false);\r\n\r\n    useEffect(() => {\r\n        fetchProjects();\r\n        // Sync state with localStorage and fetch project list if it changed\r\n        const interval = setInterval(() => {\r\n            const storedId = localStorage.getItem('active_book_id');\r\n            if (storedId !== activeBookId) {\r\n                setActiveBookId(storedId);\r\n                fetchProjects(); // Refresh sidebar list when project changes\r\n            }\r\n        }, 1500);\r\n        return () => clearInterval(interval);\r\n    }, [activeBookId]);\r\n\r\n    useEffect(() => {\r\n        if (activeBookId) {\r\n            fetchActiveBookDetails();\r\n        } else {\r\n            setActiveBookPages(null);\r\n        }\r\n    }, [activeBookId]);\r\n\r\n    const fetchProjects = async () => {\r\n        if (!supabase) return;\r\n        const { data } = await supabase\r\n            .from('books')\r\n            .select('id, title')\r\n            .order('created_at', { ascending: false });\r\n\r\n        if (data) setProjects(data);\r\n    };\r\n\r\n    const fetchActiveBookDetails = async () => {\r\n        if (!supabase || !activeBookId) return;\r\n        const { data } = await supabase\r\n            .from('books')\r\n            .select('context_data')\r\n            .eq('id', activeBookId)\r\n            .single();\r\n\r\n        if (data?.context_data?.target_pages) {\r\n            setActiveBookPages(parseInt(data.context_data.target_pages));\r\n        }\r\n    };\r\n\r\n    const handleSelectProject = async (id: string) => {\r\n        if (switching) return;\r\n        setSwitching(true);\r\n        try {\r\n            const { data } = await supabase\r\n                .from('books')\r\n                .select('status')\r\n                .eq('id', id)\r\n                .single();\r\n\r\n            localStorage.setItem('active_book_id', id);\r\n            setActiveBookId(id);\r\n            fetchProjects();\r\n\r\n            if (data) {\r\n                navigate(getRouteByStatus(data.status));\r\n            } else {\r\n                navigate('/create/concept');\r\n            }\r\n        } catch (err) {\r\n            console.error(\"Error selecting project:\", err);\r\n        } finally {\r\n            setSwitching(false);\r\n        }\r\n    };\r\n\r\n    return (\r\n        <div className=\"layout-container\">\r\n            <Sidebar\r\n                projects={projects}\r\n                onSelectProject={handleSelectProject}\r\n                activeProjectId={activeBookId}\r\n            />\r\n            <main className=\"main-content\">\r\n                {activeBookPages && location.pathname !== '/' && (\r\n                    <motion.div\r\n                        initial={{ opacity: 0, x: 20 }}\r\n                        animate={{ opacity: 1, x: 0 }}\r\n                        style={{\r\n                            position: 'fixed',\r\n                            top: '2rem',\r\n                            right: '2rem',\r\n                            zIndex: 100,\r\n                            background: 'rgba(5, 5, 5, 0.8)',\r\n                            backdropFilter: 'blur(20px)',\r\n                            padding: '0.8rem 1.5rem',\r\n                            borderRadius: '20px',\r\n                            border: '1px solid rgba(0, 242, 255, 0.2)',\r\n                            color: 'var(--primary)',\r\n                            fontSize: '0.9rem',\r\n                            fontWeight: 700,\r\n                            display: 'flex',\r\n                            alignItems: 'center',\r\n                            gap: '0.8rem',\r\n                            boxShadow: '0 10px 30px rgba(0, 0, 0, 0.5)',\r\n                            letterSpacing: '0.02em'\r\n                        }}\r\n                    >\r\n                        <div style={{\r\n                            width: '10px',\r\n                            height: '10px',\r\n                            borderRadius: '50%',\r\n                            background: 'var(--primary)',\r\n                            boxShadow: '0 0 10px var(--primary)'\r\n                        }}></div>\r\n                        Target: {activeBookPages} Pagine\r\n                    </motion.div>\r\n                )}\r\n                {switching && (\r\n                    <div style={{ position: 'fixed', inset: 0, background: 'rgba(0,0,0,0.5)', zIndex: 999, display: 'flex', alignItems: 'center', justifyContent: 'center' }}>\r\n                        <Loader2 className=\"animate-spin\" size={48} color=\"var(--primary)\" />\r\n                    </div>\r\n                )}\r\n                <Outlet />\r\n            </main>\r\n        </div>\r\n    );\r\n};\r\n\r\nexport default MainLayout;\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\genco\\Desktop\\lavoro\\w4uN8N\\src\\lib\\api.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\genco\\Desktop\\lavoro\\w4uN8N\\src\\lib\\auth.tsx","messages":[{"ruleId":"react-refresh/only-export-components","severity":2,"message":"Fast refresh only works when a file only exports components. Use a new file to share constants or functions between components.","line":326,"column":14,"nodeType":"Identifier","messageId":"namedExport","endLine":326,"endColumn":21}],"suppressedMessages":[],"errorCount":1,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import React, { createContext, useContext, useEffect, useState, useCallback } from 'react';\r\nimport { supabase, logDebug } from './api';\r\nimport type { User, Session, AuthError } from '@supabase/supabase-js';\r\n\r\n// ÔöÇÔöÇÔöÇ Error Translation Map ÔöÇÔöÇÔöÇÔöÇÔöÇÔöÇÔöÇÔöÇÔöÇÔöÇÔöÇÔöÇÔöÇÔöÇÔöÇÔöÇÔöÇÔöÇÔöÇÔöÇÔöÇÔöÇÔöÇÔöÇÔöÇÔöÇÔöÇÔöÇÔöÇÔöÇÔöÇÔöÇÔöÇÔöÇÔöÇÔöÇÔöÇÔöÇÔöÇÔöÇÔöÇÔöÇÔöÇÔöÇÔöÇÔöÇÔöÇÔöÇÔöÇÔöÇÔöÇÔöÇ\r\n// Supabase returns English error messages. We translate the most common ones\r\n// so the user sees something meaningful in Italian.\r\nconst ERROR_MAP: Record<string, string> = {\r\n    'Invalid login credentials': 'Email o password non corretti',\r\n    'Email not confirmed': 'Email non ancora confermata. Controlla la tua casella di posta.',\r\n    'User already registered': 'Questa email ├¿ gi├á registrata. Prova ad accedere.',\r\n    'Password should be at least 6 characters': 'La password deve essere di almeno 6 caratteri',\r\n    'Signup requires a valid password': 'Inserisci una password valida',\r\n    'Unable to validate email address: invalid format': 'Formato email non valido',\r\n    'Email rate limit exceeded': 'Troppi tentativi. Riprova tra qualche minuto.',\r\n    'For security purposes, you can only request this after': 'Troppi tentativi. Attendi qualche secondo e riprova.',\r\n    'Network error': 'Errore di connessione. Controlla la tua connessione internet.',\r\n};\r\n\r\n/**\r\n * Translate a Supabase auth error to a user-friendly Italian message.\r\n * Falls back to the original message if no translation is found,\r\n * but wraps completely unknown errors in a generic message.\r\n */\r\nconst translateError = (error: AuthError | Error | string): string => {\r\n    const rawMessage = typeof error === 'string' ? error : error.message;\r\n    console.warn('[Auth] Raw error from Supabase:', rawMessage);\r\n\r\n    // Check for exact matches\r\n    if (ERROR_MAP[rawMessage]) return ERROR_MAP[rawMessage];\r\n\r\n    // Check for partial matches (some Supabase errors have variable suffixes)\r\n    for (const [key, translation] of Object.entries(ERROR_MAP)) {\r\n        if (rawMessage.toLowerCase().includes(key.toLowerCase())) {\r\n            return translation;\r\n        }\r\n    }\r\n\r\n    // Fallback: don't expose raw technical errors to the user\r\n    console.error('[Auth] Untranslated error:', rawMessage);\r\n    return 'Si ├¿ verificato un errore. Riprova pi├╣ tardi.';\r\n};\r\n\r\n// ÔöÇÔöÇÔöÇ Auth Context ÔöÇÔöÇÔöÇÔöÇÔöÇÔöÇÔöÇÔöÇÔöÇÔöÇÔöÇÔöÇÔöÇÔöÇÔöÇÔöÇÔöÇÔöÇÔöÇÔöÇÔöÇÔöÇÔöÇÔöÇÔöÇÔöÇÔöÇÔöÇÔöÇÔöÇÔöÇÔöÇÔöÇÔöÇÔöÇÔöÇÔöÇÔöÇÔöÇÔöÇÔöÇÔöÇÔöÇÔöÇÔöÇÔöÇÔöÇÔöÇÔöÇÔöÇÔöÇÔöÇÔöÇÔöÇÔöÇÔöÇÔöÇÔöÇÔöÇÔöÇÔöÇÔöÇ\r\n\r\ninterface AuthContextType {\r\n    user: User | null;\r\n    session: Session | null;\r\n    loading: boolean;\r\n    authError: string | null;\r\n    signIn: (email: string, password: string) => Promise<{ error: string | null }>;\r\n    signUp: (email: string, password: string, authorName?: string) => Promise<{ error: string | null; needsConfirmation: boolean }>;\r\n    signOut: () => Promise<void>;\r\n    clearAuthError: () => void;\r\n}\r\n\r\nconst AuthContext = createContext<AuthContextType | undefined>(undefined);\r\n\r\n// ÔöÇÔöÇÔöÇ Auth Provider ÔöÇÔöÇÔöÇÔöÇÔöÇÔöÇÔöÇÔöÇÔöÇÔöÇÔöÇÔöÇÔöÇÔöÇÔöÇÔöÇÔöÇÔöÇÔöÇÔöÇÔöÇÔöÇÔöÇÔöÇÔöÇÔöÇÔöÇÔöÇÔöÇÔöÇÔöÇÔöÇÔöÇÔöÇÔöÇÔöÇÔöÇÔöÇÔöÇÔöÇÔöÇÔöÇÔöÇÔöÇÔöÇÔöÇÔöÇÔöÇÔöÇÔöÇÔöÇÔöÇÔöÇÔöÇÔöÇÔöÇÔöÇÔöÇÔöÇÔöÇÔöÇ\r\n\r\nexport const AuthProvider: React.FC<{ children: React.ReactNode }> = ({ children }) => {\r\n    const [user, setUser] = useState<User | null>(null);\r\n    const [session, setSession] = useState<Session | null>(null);\r\n    const [loading, setLoading] = useState(true);\r\n    const [authError, setAuthError] = useState<string | null>(null);\r\n\r\n    const clearAuthError = useCallback(() => setAuthError(null), []);\r\n\r\n    useEffect(() => {\r\n        console.log('[Auth] Initializing AuthProvider ÔÇö fetching session...');\r\n        const startTime = performance.now();\r\n\r\n        // Get initial session with error handling\r\n        supabase.auth.getSession()\r\n            .then(({ data: { session }, error }) => {\r\n                const duration = Math.round(performance.now() - startTime);\r\n\r\n                if (error) {\r\n                    console.error(`[Auth] getSession failed (${duration}ms):`, error.message);\r\n                    logDebug('auth', 'session_init_error', {\r\n                        error: error.message,\r\n                        duration_ms: duration\r\n                    });\r\n                    // Don't block the app ÔÇö just let the user see login\r\n                    setLoading(false);\r\n                    return;\r\n                }\r\n\r\n                if (session) {\r\n                    console.log(`[Auth] Session restored (${duration}ms) ÔÇö user:`, session.user.email);\r\n                    logDebug('auth', 'session_restored', {\r\n                        email: session.user.email,\r\n                        expires_at: session.expires_at,\r\n                        duration_ms: duration\r\n                    });\r\n                } else {\r\n                    console.log(`[Auth] No active session found (${duration}ms)`);\r\n                    logDebug('auth', 'session_none', { duration_ms: duration });\r\n                }\r\n\r\n                setSession(session);\r\n                setUser(session?.user ?? null);\r\n                setLoading(false);\r\n            })\r\n            .catch((err: unknown) => {\r\n                // Network error or Supabase unreachable\r\n                const duration = Math.round(performance.now() - startTime);\r\n                const error = err as Error;\r\n                console.error(`[Auth] getSession CRASHED (${duration}ms):`, error);\r\n                logDebug('auth', 'session_init_crash', {\r\n                    error: error.message,\r\n                    duration_ms: duration\r\n                });\r\n                setLoading(false); // Fallback: don't block the app forever\r\n            });\r\n\r\n        // Listen for auth changes (PKCE flow handles token refresh automatically)\r\n        const { data: { subscription } } = supabase.auth.onAuthStateChange(\r\n            (event, session) => {\r\n                console.log(`[Auth] Auth state changed: event=${event}, user=${session?.user?.email ?? 'none'}`);\r\n                logDebug('auth', 'state_change', {\r\n                    event,\r\n                    email: session?.user?.email,\r\n                    has_session: !!session\r\n                });\r\n\r\n                setSession(session);\r\n                setUser(session?.user ?? null);\r\n                setLoading(false);\r\n\r\n                // Handle specific events\r\n                if (event === 'SIGNED_OUT') {\r\n                    console.log('[Auth] User signed out ÔÇö clearing local state');\r\n                    setAuthError(null);\r\n                } else if (event === 'SIGNED_IN') {\r\n                    console.log('[Auth] User signed in ÔÇö claiming legacy books...');\r\n                    // Claim any unclaimed legacy books (user_id = NULL)\r\n                    supabase.rpc('claim_legacy_books').then(({ data, error }) => {\r\n                        if (error) {\r\n                            console.warn('[Auth] claim_legacy_books failed:', error.message);\r\n                            logDebug('auth', 'claim_legacy_books_error', {\r\n                                error: error.message,\r\n                                email: session?.user?.email\r\n                            });\r\n                        } else if (data && typeof data === 'number' && data > 0) {\r\n                            console.log(`[Auth] Claimed ${data} legacy book(s)`);\r\n                            logDebug('auth', 'legacy_books_claimed', {\r\n                                claimed_count: data,\r\n                                email: session?.user?.email\r\n                            });\r\n                        } else {\r\n                            console.log('[Auth] No legacy books to claim');\r\n                        }\r\n                    });\r\n                } else if (event === 'TOKEN_REFRESHED') {\r\n                    console.log('[Auth] Token refreshed successfully');\r\n                } else if (event === 'USER_UPDATED') {\r\n                    console.log('[Auth] User profile updated');\r\n                }\r\n            }\r\n        );\r\n\r\n        return () => {\r\n            console.log('[Auth] Cleaning up auth listener');\r\n            subscription.unsubscribe();\r\n        };\r\n    }, []);\r\n\r\n    // ÔöÇÔöÇÔöÇ Sign In ÔöÇÔöÇÔöÇÔöÇÔöÇÔöÇÔöÇÔöÇÔöÇÔöÇÔöÇÔöÇÔöÇÔöÇÔöÇÔöÇÔöÇÔöÇÔöÇÔöÇÔöÇÔöÇÔöÇÔöÇÔöÇÔöÇÔöÇÔöÇÔöÇÔöÇÔöÇÔöÇÔöÇÔöÇÔöÇÔöÇÔöÇÔöÇÔöÇÔöÇÔöÇÔöÇÔöÇÔöÇÔöÇÔöÇÔöÇÔöÇÔöÇÔöÇÔöÇÔöÇÔöÇÔöÇÔöÇÔöÇÔöÇÔöÇÔöÇÔöÇÔöÇÔöÇÔöÇ\r\n\r\n    const signIn = async (email: string, password: string) => {\r\n        console.log('[Auth] signIn attempt for:', email);\r\n        const startTime = performance.now();\r\n\r\n        try {\r\n            const { error } = await supabase.auth.signInWithPassword({ email, password });\r\n            const duration = Math.round(performance.now() - startTime);\r\n\r\n            if (error) {\r\n                const translated = translateError(error);\r\n                console.warn(`[Auth] signIn failed (${duration}ms):`, error.message, 'ÔåÆ', translated);\r\n                logDebug('auth', 'signin_failed', {\r\n                    email,\r\n                    error: error.message,\r\n                    translated,\r\n                    duration_ms: duration\r\n                });\r\n                setAuthError(translated);\r\n                return { error: translated };\r\n            }\r\n\r\n            console.log(`[Auth] signIn SUCCESS (${duration}ms) for:`, email);\r\n            logDebug('auth', 'signin_success', { email, duration_ms: duration });\r\n            setAuthError(null);\r\n            return { error: null };\r\n\r\n        } catch (err: unknown) {\r\n            const error = err as Error;\r\n            const duration = Math.round(performance.now() - startTime);\r\n            const translated = translateError(error);\r\n            console.error(`[Auth] signIn CRASH (${duration}ms):`, error);\r\n            logDebug('auth', 'signin_crash', {\r\n                email,\r\n                error: error.message,\r\n                duration_ms: duration\r\n            });\r\n            setAuthError(translated);\r\n            return { error: translated };\r\n        }\r\n    };\r\n\r\n    // ÔöÇÔöÇÔöÇ Sign Up ÔöÇÔöÇÔöÇÔöÇÔöÇÔöÇÔöÇÔöÇÔöÇÔöÇÔöÇÔöÇÔöÇÔöÇÔöÇÔöÇÔöÇÔöÇÔöÇÔöÇÔöÇÔöÇÔöÇÔöÇÔöÇÔöÇÔöÇÔöÇÔöÇÔöÇÔöÇÔöÇÔöÇÔöÇÔöÇÔöÇÔöÇÔöÇÔöÇÔöÇÔöÇÔöÇÔöÇÔöÇÔöÇÔöÇÔöÇÔöÇÔöÇÔöÇÔöÇÔöÇÔöÇÔöÇÔöÇÔöÇÔöÇÔöÇÔöÇÔöÇÔöÇÔöÇÔöÇ\r\n\r\n    const signUp = async (email: string, password: string, authorName?: string) => {\r\n        console.log('[Auth] signUp attempt for:', email, 'author:', authorName || '(none)');\r\n        const startTime = performance.now();\r\n\r\n        try {\r\n            const { data, error } = await supabase.auth.signUp({\r\n                email,\r\n                password,\r\n                options: {\r\n                    data: {\r\n                        author_name: authorName || ''\r\n                    }\r\n                }\r\n            });\r\n\r\n            const duration = Math.round(performance.now() - startTime);\r\n\r\n            if (error) {\r\n                const translated = translateError(error);\r\n                console.warn(`[Auth] signUp failed (${duration}ms):`, error.message, 'ÔåÆ', translated);\r\n                logDebug('auth', 'signup_failed', {\r\n                    email,\r\n                    error: error.message,\r\n                    translated,\r\n                    duration_ms: duration\r\n                });\r\n                setAuthError(translated);\r\n                return { error: translated, needsConfirmation: false };\r\n            }\r\n\r\n            // If user is returned but no session, email confirmation is required\r\n            const needsConfirmation = !!data.user && !data.session;\r\n            console.log(`[Auth] signUp SUCCESS (${duration}ms) ÔÇö needsConfirmation:`, needsConfirmation);\r\n            logDebug('auth', 'signup_success', {\r\n                email,\r\n                needs_confirmation: needsConfirmation,\r\n                duration_ms: duration\r\n            });\r\n            setAuthError(null);\r\n            return { error: null, needsConfirmation };\r\n\r\n        } catch (err: unknown) {\r\n            const error = err as Error;\r\n            const duration = Math.round(performance.now() - startTime);\r\n            const translated = translateError(error);\r\n            console.error(`[Auth] signUp CRASH (${duration}ms):`, error);\r\n            logDebug('auth', 'signup_crash', {\r\n                email,\r\n                error: error.message,\r\n                duration_ms: duration\r\n            });\r\n            setAuthError(translated);\r\n            return { error: translated, needsConfirmation: false };\r\n        }\r\n    };\r\n\r\n    // ÔöÇÔöÇÔöÇ Sign Out ÔöÇÔöÇÔöÇÔöÇÔöÇÔöÇÔöÇÔöÇÔöÇÔöÇÔöÇÔöÇÔöÇÔöÇÔöÇÔöÇÔöÇÔöÇÔöÇÔöÇÔöÇÔöÇÔöÇÔöÇÔöÇÔöÇÔöÇÔöÇÔöÇÔöÇÔöÇÔöÇÔöÇÔöÇÔöÇÔöÇÔöÇÔöÇÔöÇÔöÇÔöÇÔöÇÔöÇÔöÇÔöÇÔöÇÔöÇÔöÇÔöÇÔöÇÔöÇÔöÇÔöÇÔöÇÔöÇÔöÇÔöÇÔöÇÔöÇÔöÇÔöÇÔöÇ\r\n\r\n    const signOut = async () => {\r\n        console.log('[Auth] signOut initiated for:', user?.email);\r\n        const startTime = performance.now();\r\n\r\n        try {\r\n            const { error } = await supabase.auth.signOut();\r\n            const duration = Math.round(performance.now() - startTime);\r\n\r\n            if (error) {\r\n                console.error(`[Auth] signOut error (${duration}ms):`, error.message);\r\n                logDebug('auth', 'signout_error', {\r\n                    email: user?.email,\r\n                    error: error.message,\r\n                    duration_ms: duration\r\n                });\r\n                // Still clear local state even if Supabase errors\r\n            }\r\n\r\n            console.log(`[Auth] signOut completed (${duration}ms)`);\r\n            logDebug('auth', 'signout_success', {\r\n                email: user?.email,\r\n                duration_ms: duration\r\n            });\r\n\r\n            // Clear all app-specific local state\r\n            localStorage.removeItem('active_book_id');\r\n            setAuthError(null);\r\n\r\n        } catch (err: unknown) {\r\n            const error = err as Error;\r\n            const duration = Math.round(performance.now() - startTime);\r\n            console.error(`[Auth] signOut CRASH (${duration}ms):`, error);\r\n            logDebug('auth', 'signout_crash', {\r\n                email: user?.email,\r\n                error: error.message,\r\n                duration_ms: duration\r\n            });\r\n            // Force clean local state anyway ÔÇö user expects to be logged out\r\n            localStorage.removeItem('active_book_id');\r\n        }\r\n    };\r\n\r\n    return (\r\n        <AuthContext.Provider value={{\r\n            user, session, loading, authError,\r\n            signIn, signUp, signOut, clearAuthError\r\n        }}>\r\n            {children}\r\n        </AuthContext.Provider>\r\n    );\r\n};\r\n\r\n// ÔöÇÔöÇÔöÇ Hook ÔöÇÔöÇÔöÇÔöÇÔöÇÔöÇÔöÇÔöÇÔöÇÔöÇÔöÇÔöÇÔöÇÔöÇÔöÇÔöÇÔöÇÔöÇÔöÇÔöÇÔöÇÔöÇÔöÇÔöÇÔöÇÔöÇÔöÇÔöÇÔöÇÔöÇÔöÇÔöÇÔöÇÔöÇÔöÇÔöÇÔöÇÔöÇÔöÇÔöÇÔöÇÔöÇÔöÇÔöÇÔöÇÔöÇÔöÇÔöÇÔöÇÔöÇÔöÇÔöÇÔöÇÔöÇÔöÇÔöÇÔöÇÔöÇÔöÇÔöÇÔöÇÔöÇÔöÇÔöÇÔöÇÔöÇÔöÇÔöÇÔöÇÔöÇ\r\n\r\nexport const useAuth = (): AuthContextType => {\r\n    const context = useContext(AuthContext);\r\n    if (!context) {\r\n        throw new Error('[Auth] useAuth must be used within an AuthProvider ÔÇö check your component tree');\r\n    }\r\n    return context;\r\n};\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\genco\\Desktop\\lavoro\\w4uN8N\\src\\lib\\navigation.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\genco\\Desktop\\lavoro\\w4uN8N\\src\\lib\\useTheme.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\genco\\Desktop\\lavoro\\w4uN8N\\src\\main.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\genco\\Desktop\\lavoro\\w4uN8N\\src\\pages\\Dashboard.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\genco\\Desktop\\lavoro\\w4uN8N\\src\\pages\\auth\\LoginPage.tsx","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":19,"column":37,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":19,"endColumn":40,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[810,813],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[810,813],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":1,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import React, { useState, useEffect } from 'react';\r\nimport { useNavigate, useLocation, Link } from 'react-router-dom';\r\nimport { useAuth } from '../../lib/auth';\r\nimport { logDebug } from '../../lib/api';\r\nimport { motion } from 'framer-motion';\r\nimport { Book, LogIn, Eye, EyeOff, AlertCircle, WifiOff } from 'lucide-react';\r\n\r\nconst LoginPage: React.FC = () => {\r\n    const navigate = useNavigate();\r\n    const location = useLocation();\r\n    const { signIn, user, clearAuthError } = useAuth();\r\n\r\n    const [email, setEmail] = useState('');\r\n    const [password, setPassword] = useState('');\r\n    const [showPassword, setShowPassword] = useState(false);\r\n    const [error, setError] = useState<string | null>(null);\r\n    const [loading, setLoading] = useState(false);\r\n\r\n    const from = (location.state as any)?.from?.pathname || '/';\r\n\r\n    // If user is already logged in, redirect away from login\r\n    useEffect(() => {\r\n        if (user) {\r\n            console.log('[LoginPage] User already authenticated ÔÇö redirecting to:', from);\r\n            navigate(from, { replace: true });\r\n        }\r\n    }, [user, from, navigate]);\r\n\r\n    // Clear previous errors when mounting\r\n    useEffect(() => {\r\n        console.log('[LoginPage] Mounted ÔÇö redirect target:', from);\r\n        clearAuthError();\r\n    }, [clearAuthError, from]);\r\n\r\n    const handleSubmit = async (e: React.FormEvent) => {\r\n        e.preventDefault();\r\n        setError(null);\r\n        setLoading(true);\r\n\r\n        console.log('[LoginPage] Login form submitted for:', email);\r\n\r\n        // Client-side validation\r\n        if (!email.trim()) {\r\n            const msg = 'Inserisci il tuo indirizzo email';\r\n            console.warn('[LoginPage] Validation: empty email');\r\n            setError(msg);\r\n            setLoading(false);\r\n            return;\r\n        }\r\n\r\n        if (!password) {\r\n            const msg = 'Inserisci la password';\r\n            console.warn('[LoginPage] Validation: empty password');\r\n            setError(msg);\r\n            setLoading(false);\r\n            return;\r\n        }\r\n\r\n        const startTime = performance.now();\r\n        const { error: signInError } = await signIn(email, password);\r\n        const duration = Math.round(performance.now() - startTime);\r\n\r\n        if (signInError) {\r\n            console.warn(`[LoginPage] Login failed (${duration}ms):`, signInError);\r\n            setError(signInError);\r\n            setLoading(false);\r\n        } else {\r\n            console.log(`[LoginPage] Login success (${duration}ms) ÔÇö navigating to:`, from);\r\n            logDebug('auth', 'login_page_success', { email, redirect_to: from, duration_ms: duration });\r\n            navigate(from, { replace: true });\r\n        }\r\n    };\r\n\r\n    return (\r\n        <div style={{\r\n            width: '100vw',\r\n            height: '100vh',\r\n            display: 'flex',\r\n            alignItems: 'center',\r\n            justifyContent: 'center',\r\n            background: 'var(--bg-dark)',\r\n            backgroundImage: `\r\n                radial-gradient(at 20% 30%, rgba(0, 242, 255, 0.06) 0px, transparent 50%),\r\n                radial-gradient(at 80% 70%, rgba(34, 211, 238, 0.04) 0px, transparent 50%)\r\n            `,\r\n            overflow: 'hidden'\r\n        }}>\r\n            {/* Background Grid */}\r\n            <div style={{\r\n                position: 'absolute', inset: 0, overflow: 'hidden', pointerEvents: 'none'\r\n            }}>\r\n                <div className=\"loading-grid\" style={{ opacity: 0.3 }} />\r\n            </div>\r\n\r\n            <motion.div\r\n                initial={{ opacity: 0, y: 30, scale: 0.95 }}\r\n                animate={{ opacity: 1, y: 0, scale: 1 }}\r\n                transition={{ duration: 0.6, ease: [0.16, 1, 0.3, 1] }}\r\n                className=\"glass-panel\"\r\n                style={{\r\n                    width: '100%',\r\n                    maxWidth: '440px',\r\n                    padding: '3rem',\r\n                    position: 'relative',\r\n                    zIndex: 1\r\n                }}\r\n            >\r\n                {/* Logo */}\r\n                <div style={{\r\n                    display: 'flex', alignItems: 'center', justifyContent: 'center',\r\n                    gap: '0.75rem', marginBottom: '2.5rem'\r\n                }}>\r\n                    <div style={{\r\n                        background: 'linear-gradient(135deg, var(--primary), var(--accent))',\r\n                        padding: '0.6rem', borderRadius: '14px',\r\n                        boxShadow: '0 0 25px rgba(0, 242, 255, 0.3)'\r\n                    }}>\r\n                        <Book size={24} color=\"black\" />\r\n                    </div>\r\n                    <h1 style={{\r\n                        fontSize: '1.8rem', letterSpacing: '-0.05em',\r\n                        background: 'linear-gradient(135deg, var(--primary), var(--accent))',\r\n                        WebkitBackgroundClip: 'text', WebkitTextFillColor: 'transparent'\r\n                    }}>\r\n                        W4U Wizard\r\n                    </h1>\r\n                </div>\r\n\r\n                <p style={{\r\n                    textAlign: 'center', color: 'var(--text-muted)',\r\n                    fontSize: '0.9rem', marginBottom: '2rem'\r\n                }}>\r\n                    Accedi al tuo workspace creativo\r\n                </p>\r\n\r\n                {/* Error Banner */}\r\n                {error && (\r\n                    <motion.div\r\n                        initial={{ opacity: 0, y: -10 }}\r\n                        animate={{ opacity: 1, y: 0 }}\r\n                        style={{\r\n                            display: 'flex', alignItems: 'flex-start', gap: '0.6rem',\r\n                            padding: '0.8rem 1rem', borderRadius: '12px',\r\n                            background: error.includes('connessione')\r\n                                ? 'rgba(251, 191, 36, 0.1)'\r\n                                : 'rgba(251, 113, 133, 0.1)',\r\n                            border: error.includes('connessione')\r\n                                ? '1px solid rgba(251, 191, 36, 0.3)'\r\n                                : '1px solid rgba(251, 113, 133, 0.3)',\r\n                            marginBottom: '1.5rem', fontSize: '0.85rem',\r\n                            color: error.includes('connessione') ? '#fbbf24' : 'var(--error)'\r\n                        }}\r\n                    >\r\n                        {error.includes('connessione') ? (\r\n                            <WifiOff size={16} style={{ flexShrink: 0, marginTop: '2px' }} />\r\n                        ) : (\r\n                            <AlertCircle size={16} style={{ flexShrink: 0, marginTop: '2px' }} />\r\n                        )}\r\n                        <span>{error}</span>\r\n                    </motion.div>\r\n                )}\r\n\r\n                {/* Form */}\r\n                <form onSubmit={handleSubmit} style={{ display: 'flex', flexDirection: 'column', gap: '1.2rem' }}>\r\n                    <div>\r\n                        <label style={{\r\n                            display: 'block', fontSize: '0.75rem', fontWeight: 600,\r\n                            color: 'var(--text-muted)', marginBottom: '0.5rem',\r\n                            letterSpacing: '0.05em', textTransform: 'uppercase'\r\n                        }}>\r\n                            Email\r\n                        </label>\r\n                        <input\r\n                            type=\"email\"\r\n                            value={email}\r\n                            onChange={e => { setEmail(e.target.value); setError(null); }}\r\n                            placeholder=\"la-tua@email.com\"\r\n                            required\r\n                            autoComplete=\"email\"\r\n                            autoFocus\r\n                            style={{ width: '100%' }}\r\n                        />\r\n                    </div>\r\n\r\n                    <div>\r\n                        <label style={{\r\n                            display: 'block', fontSize: '0.75rem', fontWeight: 600,\r\n                            color: 'var(--text-muted)', marginBottom: '0.5rem',\r\n                            letterSpacing: '0.05em', textTransform: 'uppercase'\r\n                        }}>\r\n                            Password\r\n                        </label>\r\n                        <div style={{ position: 'relative' }}>\r\n                            <input\r\n                                type={showPassword ? 'text' : 'password'}\r\n                                value={password}\r\n                                onChange={e => { setPassword(e.target.value); setError(null); }}\r\n                                placeholder=\"ÔÇóÔÇóÔÇóÔÇóÔÇóÔÇóÔÇóÔÇó\"\r\n                                required\r\n                                autoComplete=\"current-password\"\r\n                                style={{ width: '100%', paddingRight: '3rem' }}\r\n                            />\r\n                            <button\r\n                                type=\"button\"\r\n                                onClick={() => setShowPassword(!showPassword)}\r\n                                style={{\r\n                                    position: 'absolute', right: '0.8rem', top: '50%',\r\n                                    transform: 'translateY(-50%)', background: 'none',\r\n                                    border: 'none', cursor: 'pointer', padding: '0.3rem',\r\n                                    color: 'var(--text-muted)'\r\n                                }}\r\n                                tabIndex={-1}\r\n                                aria-label={showPassword ? 'Nascondi password' : 'Mostra password'}\r\n                            >\r\n                                {showPassword ? <EyeOff size={18} /> : <Eye size={18} />}\r\n                            </button>\r\n                        </div>\r\n                    </div>\r\n\r\n                    <button\r\n                        type=\"submit\"\r\n                        className=\"btn-primary\"\r\n                        disabled={loading || !email || !password}\r\n                        style={{ width: '100%', marginTop: '0.5rem', gap: '0.6rem' }}\r\n                    >\r\n                        {loading ? (\r\n                            <div className=\"animate-spin\" style={{ width: 18, height: 18, border: '2px solid rgba(0,0,0,0.3)', borderTopColor: '#000', borderRadius: '50%' }} />\r\n                        ) : (\r\n                            <LogIn size={18} />\r\n                        )}\r\n                        {loading ? 'Accesso in corso...' : 'Accedi'}\r\n                    </button>\r\n                </form>\r\n\r\n                {/* Register Link */}\r\n                <p style={{\r\n                    textAlign: 'center', marginTop: '2rem',\r\n                    color: 'var(--text-muted)', fontSize: '0.85rem'\r\n                }}>\r\n                    Non hai un account?{' '}\r\n                    <Link to=\"/register\" style={{\r\n                        color: 'var(--primary)', textDecoration: 'none',\r\n                        fontWeight: 600, transition: 'opacity 0.2s'\r\n                    }}>\r\n                        Registrati\r\n                    </Link>\r\n                </p>\r\n            </motion.div>\r\n        </div>\r\n    );\r\n};\r\n\r\nexport default LoginPage;\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\genco\\Desktop\\lavoro\\w4uN8N\\src\\pages\\auth\\RegisterPage.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\genco\\Desktop\\lavoro\\w4uN8N\\src\\pages\\wizard\\BlueprintPage.tsx","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":178,"column":23,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":178,"endColumn":26,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[7173,7176],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[7173,7176],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":1,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import React, { useState, useEffect } from 'react';\r\nimport { useNavigate } from 'react-router-dom';\r\nimport { CheckCircle, Loader2 } from 'lucide-react';\r\nimport { supabase, callBookAgent, logDebug } from '../../lib/api';\r\n\r\ninterface Chapter {\r\n    id: string;\r\n    title: string;\r\n    summary: string;\r\n    paragraphs?: Array<{ title: string; description: string }>;\r\n}\r\n\r\n\r\nconst BlueprintPage: React.FC = () => {\r\n    const navigate = useNavigate();\r\n    const [chapters, setChapters] = useState<Chapter[]>([]);\r\n    const [saving, setSaving] = useState(false);\r\n    const [chapterFeedbacks, setChapterFeedbacks] = useState<Record<string, string>>({});\r\n    const [modifiedChapters, setModifiedChapters] = useState<Set<string>>(new Set());\r\n    const [refreshing, setRefreshing] = useState<string | null>(null);\r\n\r\n    useEffect(() => {\r\n        const loadChapters = async () => {\r\n            const saved = localStorage.getItem('project_chapters');\r\n            if (saved) {\r\n                try {\r\n                    setChapters(JSON.parse(saved));\r\n                    return;\r\n                } catch (e) {\r\n                    console.error(\"Failed to parse chapters\", e);\r\n                }\r\n            }\r\n\r\n            // Fallback: fetch from DB if bookId exists\r\n            const bookId = localStorage.getItem('active_book_id');\r\n            if (bookId) {\r\n                const { data } = await supabase\r\n                    .from('chapters')\r\n                    .select('id, title, summary, structure')\r\n                    .eq('book_id', bookId)\r\n                    .order('chapter_number', { ascending: true });\r\n\r\n                if (data && data.length > 0) {\r\n                    const formatted = data.map(d => ({\r\n                        id: d.id,\r\n                        title: d.title,\r\n                        summary: d.summary,\r\n                        paragraphs: d.structure as Array<{ title: string; description: string }> || []\r\n                    }));\r\n                    setChapters(formatted);\r\n                    localStorage.setItem('project_chapters', JSON.stringify(formatted));\r\n                }\r\n            }\r\n        };\r\n\r\n        loadChapters();\r\n    }, []);\r\n\r\n    const handleConfirm = async () => {\r\n        const bookId = localStorage.getItem('active_book_id');\r\n        if (!bookId || chapters.length === 0) return;\r\n\r\n        setSaving(true);\r\n        const startTime = performance.now();\r\n        await logDebug('frontend', 'blueprint_confirm_start', { chapters_count: chapters.length }, bookId);\r\n\r\n        try {\r\n            const dbChapters = chapters.map((c, index) => ({\r\n                book_id: bookId,\r\n                chapter_number: index + 1,\r\n                title: c.title,\r\n                summary: c.summary,\r\n                structure: c.paragraphs, // Save paragraphs to DB\r\n                status: 'PENDING'\r\n            }));\r\n\r\n            const { error } = await supabase\r\n                .from('chapters')\r\n                .insert(dbChapters);\r\n\r\n            if (error) throw error;\r\n\r\n            await supabase\r\n                .from('books')\r\n                .update({ status: 'PRODUCTION' })\r\n                .eq('id', bookId);\r\n\r\n            await logDebug('frontend', 'blueprint_confirm_success', {\r\n                duration_ms: Math.round(performance.now() - startTime)\r\n            }, bookId);\r\n\r\n            navigate('/create/production');\r\n\r\n        } catch (err: unknown) {\r\n            const error = err as Error;\r\n            console.error(\"Error saving blueprint:\", error);\r\n            await logDebug('frontend', 'blueprint_confirm_error', {\r\n                error: error.message,\r\n                duration_ms: Math.round(performance.now() - startTime)\r\n            }, bookId);\r\n            alert(\"Errore salvataggio struttura.\");\r\n        } finally {\r\n            setSaving(false);\r\n        }\r\n    };\r\n\r\n    const handleChapterModification = async (chapterId: string, index: number) => {\r\n        const feedback = chapterFeedbacks[chapterId];\r\n        if (!feedback) return;\r\n\r\n        const bookId = localStorage.getItem('active_book_id');\r\n        setRefreshing(chapterId);\r\n\r\n        await logDebug('frontend', 'chapter_modification_start', {\r\n            chapterIndex: index,\r\n            chapterId: chapterId,\r\n            feedback_length: feedback.length\r\n        }, bookId);\r\n\r\n        const startTime = performance.now();\r\n\r\n        try {\r\n            const data = await callBookAgent('OUTLINE', {\r\n                feedback,\r\n                targetChapterIndex: index, // Indicating which chapter to change if the agent supports it\r\n                currentChapters: chapters.map(c => ({ title: c.title, summary: c.summary, paragraphs: c.paragraphs }))\r\n            }, bookId);\r\n            const resData = data.data || data;\r\n\r\n            if (resData.bookId) {\r\n                localStorage.setItem('active_book_id', resData.bookId);\r\n            }\r\n\r\n            if (resData.chapters) {\r\n                setChapters(prev => {\r\n                    const next = [...prev];\r\n                    const aiChapter = resData.chapters[index];\r\n\r\n                    if (aiChapter && next[index]) {\r\n                        // Granular update: only change the targeted chapter\r\n                        next[index] = {\r\n                            ...next[index],\r\n                            title: aiChapter.title,\r\n                            summary: aiChapter.summary || aiChapter.scene_description,\r\n                            paragraphs: aiChapter.paragraphs // Update paragraphs from AI\r\n                        };\r\n                    } else {\r\n                        // Fallback: Use the new list but preserve IDs where possible\r\n                        const fallback = resData.chapters.map((c: { title: string; summary?: string; scene_description?: string; paragraphs?: Array<{ title: string; description: string }> }, i: number) => ({\r\n                            id: prev[i]?.id || `chap-${i}-${Date.now()}`,\r\n                            title: c.title,\r\n                            summary: c.summary || c.scene_description || '',\r\n                            paragraphs: c.paragraphs || []\r\n                        }));\r\n                        localStorage.setItem('project_chapters', JSON.stringify(fallback));\r\n                        return fallback;\r\n                    }\r\n\r\n                    localStorage.setItem('project_chapters', JSON.stringify(next));\r\n                    return next;\r\n                });\r\n\r\n                // Track that this chapter was modified\r\n                setModifiedChapters(prev => new Set(prev).add(chapterId));\r\n\r\n                // Clear feedback for this chapter\r\n                setChapterFeedbacks(prev => {\r\n                    const next = { ...prev };\r\n                    delete next[chapterId];\r\n                    return next;\r\n                });\r\n\r\n                await logDebug('frontend', 'chapter_modification_success', {\r\n                    chapterId,\r\n                    duration_ms: Math.round(performance.now() - startTime)\r\n                }, bookId);\r\n            }\r\n        } catch (err: any) {\r\n            console.error(err);\r\n            await logDebug('frontend', 'chapter_modification_error', {\r\n                chapterId,\r\n                error: err.message,\r\n                duration_ms: Math.round(performance.now() - startTime)\r\n            }, bookId);\r\n            alert(\"Errore durante l'aggiornamento. Riprova.\");\r\n        } finally {\r\n            setRefreshing(null);\r\n        }\r\n    };\r\n\r\n    return (\r\n        <div className=\"container-narrow fade-in\" style={{ paddingTop: '2rem', paddingBottom: '4rem' }}>\r\n            <div style={{ display: 'flex', gap: '1rem', marginBottom: '3rem', justifyContent: 'center' }}>\r\n                <div style={{ height: '4px', width: '40px', background: 'var(--success)', borderRadius: '2px' }}></div>\r\n                <div style={{ height: '4px', width: '40px', background: 'var(--success)', borderRadius: '2px' }}></div>\r\n                <div style={{ height: '4px', width: '40px', background: 'var(--primary)', borderRadius: '2px' }}></div>\r\n                <div style={{ height: '4px', width: '40px', background: 'var(--glass-border)', borderRadius: '2px' }}></div>\r\n            </div>\r\n\r\n            <header style={{ marginBottom: '2rem', textAlign: 'center' }}>\r\n                <h1 style={{ fontSize: '2.5rem', marginBottom: '1rem' }}>L'Architetto ha disegnato questo.</h1>\r\n                <p style={{ color: 'var(--text-muted)', fontSize: '1.2rem' }}>\r\n                    Questa ├¿ l'ossatura del tuo libro. La struttura ├¿ fissa per garantire la coerenza del volume scelto.\r\n                </p>\r\n            </header>\r\n\r\n            <div style={{ display: 'flex', flexDirection: 'column', gap: '1rem' }}>\r\n                {chapters.map((chapter, index) => {\r\n                    const isModified = modifiedChapters.has(chapter.id);\r\n                    const isRefreshing = refreshing === chapter.id;\r\n\r\n                    return (\r\n                        <div key={chapter.id} className=\"glass-panel\" style={{\r\n                            padding: '1.5rem',\r\n                            display: 'flex',\r\n                            flexDirection: 'column',\r\n                            gap: '1rem',\r\n                            background: 'rgba(30, 41, 59, 0.4)',\r\n                            border: isModified ? '1px solid var(--success)' : '1px solid var(--glass-border)',\r\n                            opacity: isModified ? 0.8 : 1,\r\n                            transition: 'all 0.3s ease'\r\n                        }}>\r\n                            <div style={{ display: 'flex', alignItems: 'center', gap: '1rem' }}>\r\n                                <div style={{ flex: 1 }}>\r\n                                    <input\r\n                                        className=\"invisible-input\"\r\n                                        value={chapter.title}\r\n                                        readOnly\r\n                                        style={{\r\n                                            fontWeight: 700,\r\n                                            fontSize: '1.1rem',\r\n                                            marginBottom: '0.2rem',\r\n                                            width: '100%',\r\n                                            background: 'transparent',\r\n                                            border: 'none',\r\n                                            padding: 0,\r\n                                            color: 'var(--text-main)',\r\n                                            cursor: 'default'\r\n                                        }}\r\n                                    />\r\n                                    <input\r\n                                        className=\"invisible-input\"\r\n                                        value={chapter.summary}\r\n                                        readOnly\r\n                                        style={{\r\n                                            fontSize: '0.9rem',\r\n                                            color: 'var(--text-muted)',\r\n                                            width: '100%',\r\n                                            background: 'transparent',\r\n                                            border: 'none',\r\n                                            padding: 0,\r\n                                            cursor: 'default'\r\n                                        }}\r\n                                    />\r\n                                </div>\r\n                                {isModified && (\r\n                                    <div style={{ display: 'flex', alignItems: 'center', gap: '0.5rem', color: 'var(--success)', fontSize: '0.8rem', fontWeight: 600 }}>\r\n                                        <CheckCircle size={16} /> Modificato\r\n                                    </div>\r\n                                )}\r\n                            </div>\r\n\r\n                            {!isModified && (\r\n                                <div style={{ marginTop: '0.5rem', display: 'flex', flexDirection: 'column', gap: '0.8rem' }}>\r\n                                    <div style={{ position: 'relative' }}>\r\n                                        <textarea\r\n                                            placeholder=\"Cosa vorresti cambiare in questo capitolo? (max 200 caratteri)\"\r\n                                            value={chapterFeedbacks[chapter.id] || ''}\r\n                                            onChange={(e) => setChapterFeedbacks(prev => ({ ...prev, [chapter.id]: e.target.value.slice(0, 200) }))}\r\n                                            maxLength={200}\r\n                                            style={{\r\n                                                width: '100%',\r\n                                                padding: '0.8rem',\r\n                                                paddingBottom: '1.5rem',\r\n                                                borderRadius: '8px',\r\n                                                background: 'rgba(0,0,0,0.2)',\r\n                                                border: '1px solid var(--glass-border)',\r\n                                                color: 'white',\r\n                                                minHeight: '80px',\r\n                                                fontSize: '0.85rem',\r\n                                                resize: 'none'\r\n                                            }}\r\n                                            disabled={refreshing !== null}\r\n                                        />\r\n                                        <div style={{\r\n                                            position: 'absolute',\r\n                                            bottom: '5px',\r\n                                            right: '10px',\r\n                                            fontSize: '0.7rem',\r\n                                            color: (chapterFeedbacks[chapter.id] || '').length >= 180 ? 'var(--error)' : 'var(--text-muted)',\r\n                                            fontWeight: 600\r\n                                        }}>\r\n                                            {(chapterFeedbacks[chapter.id] || '').length} / 200\r\n                                        </div>\r\n                                    </div>\r\n                                    <button\r\n                                        onClick={() => handleChapterModification(chapter.id, index)}\r\n                                        disabled={refreshing !== null || !chapterFeedbacks[chapter.id]}\r\n                                        className=\"btn-secondary\"\r\n                                        style={{ padding: '0.5rem 1rem', alignSelf: 'flex-end', fontSize: '0.8rem' }}\r\n                                    >\r\n                                        {isRefreshing ? <><Loader2 size={14} className=\"animate-spin\" /> ...</> : 'Applica Modifica'}\r\n                                    </button>\r\n                                </div>\r\n                            )}\r\n                        </div>\r\n                    );\r\n                })}\r\n            </div>\r\n\r\n\r\n            <div style={{ marginTop: '2rem', display: 'flex', justifyContent: 'flex-end' }}>\r\n                <button onClick={handleConfirm} className=\"btn-primary\" disabled={saving} style={{ padding: '0.8rem 2rem' }}>\r\n                    {saving ? <Loader2 className=\"animate-spin\" /> : <><CheckCircle size={18} /> Conferma Struttura Finale</>}\r\n                </button>\r\n            </div>\r\n        </div>\r\n    );\r\n};\r\n\r\nexport default BlueprintPage;\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\genco\\Desktop\\lavoro\\w4uN8N\\src\\pages\\wizard\\ConceptPage.tsx","messages":[{"ruleId":"react-hooks/exhaustive-deps","severity":1,"message":"React Hook useEffect has a missing dependency: 'fetchBookData'. Either include it or remove the dependency array.","line":47,"column":8,"nodeType":"ArrayExpression","endLine":47,"endColumn":16,"suggestions":[{"desc":"Update the dependencies array to be: [bookId, fetchBookData]","fix":{"range":[1980,1988],"text":"[bookId, fetchBookData]"}}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import React, { useState, useEffect } from 'react';\r\nimport { useNavigate } from 'react-router-dom';\r\nimport { motion } from 'framer-motion';\r\nimport { Sparkles, ArrowRight, Loader2, Upload, FileText, User, AlertCircle } from 'lucide-react';\r\nimport { callBookAgent, supabase, logDebug } from '../../lib/api';\r\nimport { getQuestionsForGenre } from '../../data/genres';\r\nimport mammoth from 'mammoth';\r\nimport type { ConceptCard } from '../../types';\r\nimport { useToast } from '../../context/ToastContext';\r\n\r\n\r\nconst CONCEPT_LOADING_PHASES = [\r\n    'Analisi delle tue risposte...',\r\n    'Lettura dei materiali caricati...',\r\n    'Esplorazione temi narrativi...',\r\n    'Sviluppo archi narrativi...',\r\n    'Creazione personaggi chiave...',\r\n    'Definizione ambientazioni...',\r\n    'Composizione proposte di concept...',\r\n    'Rifinitura idee...',\r\n];\r\n\r\nconst ConceptPage: React.FC = () => {\r\n    const navigate = useNavigate();\r\n    const { success, error: toastError } = useToast();\r\n    const [loading, setLoading] = useState(false);\r\n    const [concepts, setConcepts] = useState<ConceptCard[]>([]);\r\n    const [bookTitle, setBookTitle] = useState<string | null>(null);\r\n    const [genre, setGenre] = useState<string | null>(null);\r\n    const [answers, setAnswers] = useState<string[]>(Array(8).fill(''));\r\n    const [loadingMessage, setLoadingMessage] = useState(CONCEPT_LOADING_PHASES[0]);\r\n\r\n    // New State for Phase 1\r\n    const [authorName, setAuthorName] = useState('');\r\n    const [pseudonym, setPseudonym] = useState('');\r\n    const [uploadedFileContent, setUploadedFileContent] = useState<string>('');\r\n    const [fileName, setFileName] = useState<string | null>(null);\r\n    const [isAnalyzingFile, setIsAnalyzingFile] = useState(false);\r\n    const [fileError, setFileError] = useState<string | null>(null);\r\n\r\n    const bookId = localStorage.getItem('active_book_id');\r\n\r\n    useEffect(() => {\r\n        if (bookId) {\r\n            fetchBookData();\r\n        }\r\n    }, [bookId]);\r\n\r\n    // Rotating loading messages\r\n    useEffect(() => {\r\n        if (!loading) return;\r\n        let phaseIndex = 0;\r\n        setLoadingMessage(CONCEPT_LOADING_PHASES[0]);\r\n        const interval = setInterval(() => {\r\n            phaseIndex = (phaseIndex + 1) % CONCEPT_LOADING_PHASES.length;\r\n            setLoadingMessage(CONCEPT_LOADING_PHASES[phaseIndex]);\r\n        }, 2500);\r\n        return () => clearInterval(interval);\r\n    }, [loading]);\r\n\r\n    const fetchBookData = async () => {\r\n        if (!supabase || !bookId) return;\r\n        const { data } = await supabase.from('books').select('title, genre, context_data, author').eq('id', bookId).single();\r\n        if (data) {\r\n            setBookTitle(data.title);\r\n            setGenre(data.genre);\r\n            setAuthorName(data.author || '');\r\n            if (data.context_data?.answers) {\r\n                setAnswers(data.context_data.answers);\r\n            }\r\n            if (data.context_data?.pseudonym) {\r\n                setPseudonym(data.context_data.pseudonym);\r\n            }\r\n            // If we stored file content previously, retrieve (optional, might be too heavy for DB context_data, better to just keep in UI state if navigating back)\r\n        }\r\n    };\r\n\r\n    const handleAnswerChange = (index: number, value: string) => {\r\n        const newAnswers = [...answers];\r\n        newAnswers[index] = value;\r\n        setAnswers(newAnswers);\r\n    };\r\n\r\n    const handleFileUpload = async (event: React.ChangeEvent<HTMLInputElement>) => {\r\n        const file = event.target.files?.[0];\r\n        if (!file) return;\r\n\r\n        setFileError(null);\r\n        setIsAnalyzingFile(true);\r\n        setFileName(file.name);\r\n\r\n        try {\r\n            if (file.size > 5 * 1024 * 1024) { // 5MB limit\r\n                throw new Error('Il file ├¿ troppo grande. Max 5MB.');\r\n            }\r\n\r\n            let text = '';\r\n            if (file.name.endsWith('.docx')) {\r\n                const arrayBuffer = await file.arrayBuffer();\r\n                const result = await mammoth.extractRawText({ arrayBuffer });\r\n                text = result.value;\r\n                if (result.messages.length > 0) {\r\n                    console.warn('Mammoth messages:', result.messages);\r\n                }\r\n            } else if (file.name.endsWith('.txt')) {\r\n                text = await file.text();\r\n            } else {\r\n                throw new Error('Formato non supportato. Usa .docx o .txt');\r\n            }\r\n\r\n            // Basic check for length (approx 150 pages ~ 60k words ~ 400k chars)\r\n            if (text.length > 500000) {\r\n                throw new Error('Il testo ├¿ troppo lungo (Max 150 pagine circa).');\r\n            }\r\n\r\n            setUploadedFileContent(text);\r\n            await logDebug('frontend', 'file_uploaded', { fileName: file.name, length: text.length }, bookId);\r\n            success('File caricato con successo!');\r\n\r\n        } catch (err: unknown) {\r\n            const error = err as Error;\r\n            console.error(error);\r\n            setFileError(error.message);\r\n            toastError(error.message);\r\n            setFileName(null);\r\n            setUploadedFileContent('');\r\n        } finally {\r\n            setIsAnalyzingFile(false);\r\n        }\r\n    };\r\n\r\n    const selectConcept = async (concept: ConceptCard) => {\r\n        const bookId = localStorage.getItem('active_book_id');\r\n        if (!bookId) return;\r\n\r\n        await logDebug('frontend', 'concept_selected', { conceptId: concept.id, title: concept.title }, bookId);\r\n\r\n        try {\r\n            const { data: currentBook } = await supabase\r\n                .from('books')\r\n                .select('context_data')\r\n                .eq('id', bookId)\r\n                .single();\r\n\r\n            const currentContext = currentBook?.context_data || {};\r\n\r\n            await supabase\r\n                .from('books')\r\n                .update({\r\n                    status: 'CONFIGURATION',\r\n                    title: concept.title,\r\n                    author: authorName || 'Autore Sconosciuto', // Save Author Name\r\n                    context_data: {\r\n                        ...currentContext,\r\n                        selected_concept: concept,\r\n                        answers: answers,\r\n                        pseudonym: pseudonym,\r\n                        uploaded_materials_summary: uploadedFileContent ? 'Materiale caricato presente' : 'Nessun materiale'\r\n                        // We do NOT save the full text in context_data to avoid DB bloat, it was sent to AI agent already\r\n                    }\r\n                })\r\n                .eq('id', bookId);\r\n\r\n            setBookTitle(concept.title);\r\n            navigate('/create/configuration');\r\n        } catch (err: unknown) {\r\n            const error = err as Error;\r\n            console.error(error);\r\n            toastError(\"Errore durante la selezione del concept. Riprova.\");\r\n            await logDebug('frontend', 'concept_selection_error', { error: error.message }, bookId);\r\n        }\r\n    };\r\n\r\n    const handleGenerateConcepts = async () => {\r\n        setLoading(true);\r\n        const bookId = localStorage.getItem('active_book_id');\r\n\r\n        const questions = getQuestionsForGenre(genre || '');\r\n        const interviewContext = questions.map((q, i) => `D: ${q}\\nR: ${answers[i]}`).join('\\n\\n');\r\n\r\n        let fullContext = `INTERVISTA:\\n${interviewContext}`;\r\n\r\n        if (authorName) fullContext += `\\n\\nNOME AUTORE: ${authorName}`;\r\n        if (pseudonym) fullContext += `\\nPSEUDONIMO: ${pseudonym}`;\r\n\r\n        if (uploadedFileContent) {\r\n            fullContext += `\\n\\n=== MATERIALE AGGIUNTIVO CARICATO DALL'UTENTE (BOZZE/APPUNTI) ===\\n${uploadedFileContent}\\n=== FINE MATERIALE AGGIUNTIVO ===\\n\\nISTRUZIONI: Dai MOLTO peso al materiale caricato. Usalo come base fondamentale per lo stile e i contenuti.`;\r\n        }\r\n\r\n        await logDebug('frontend', 'concept_generation_start', {\r\n            genre,\r\n            inputs_length: fullContext.length,\r\n            has_file: !!uploadedFileContent\r\n        }, bookId);\r\n\r\n        const startTime = performance.now();\r\n\r\n        try {\r\n            // Update book author immediately\r\n            if (bookId && authorName) {\r\n                await supabase.from('books').update({ author: authorName }).eq('id', bookId);\r\n            }\r\n\r\n            const data = await callBookAgent('GENERATE_CONCEPTS', { userInput: fullContext, title: bookTitle }, bookId);\r\n            const generatedData = data.data || data;\r\n\r\n            if (generatedData.bookId) {\r\n                localStorage.setItem('active_book_id', generatedData.bookId);\r\n            }\r\n\r\n            if (generatedData.concepts) {\r\n                setConcepts(generatedData.concepts);\r\n                await logDebug('frontend', 'concept_generation_complete', {\r\n                    count: generatedData.concepts.length,\r\n                    duration_ms: Math.round(performance.now() - startTime)\r\n                }, bookId);\r\n            }\r\n        } catch (err: unknown) {\r\n            const error = err as Error;\r\n            console.error(error);\r\n            toastError(\"Errore nella generazione dei concept. Riprova pi├╣ tardi.\");\r\n            await logDebug('frontend', 'concept_generation_error', {\r\n                error: error.message,\r\n                duration_ms: Math.round(performance.now() - startTime)\r\n            }, bookId);\r\n        } finally {\r\n            setLoading(false);\r\n        }\r\n    };\r\n\r\n\r\n\r\n    const questions = getQuestionsForGenre(genre || '');\r\n    const answeredCount = answers.filter(a => a.trim().length > 0).length;\r\n    // Require answers OR a file upload with substantial content. \r\n    // User policy: \"Upload does not exempt from questions\", BUT maybe relax if file is huge? \r\n    // \"L'eventuale upload del word non esime l'utente dalla fase delle domande.\" -> OK, keep mandatory questions.\r\n    const isComplete = answeredCount >= 4 && !!authorName; // Added authorName requirement? Let's make it optional or mandatory. \"bisogna anche chiedere nome e cognome\". Let's make it mandatory.\r\n\r\n    return (\r\n        <>\r\n            {/* OVERLAY GENERAZIONE CONCEPT */}\r\n            {loading && (\r\n                <div style={{\r\n                    position: 'fixed',\r\n                    inset: 0,\r\n                    background: 'rgba(5, 5, 8, 0.95)',\r\n                    backdropFilter: 'blur(20px)',\r\n                    zIndex: 9999, // Increased z-index\r\n                    display: 'flex',\r\n                    flexDirection: 'column',\r\n                    alignItems: 'center',\r\n                    justifyContent: 'center',\r\n                    gap: '2rem',\r\n                    animation: 'fadeIn 0.3s ease-out'\r\n                }}>\r\n                    {/* Spinner animato */}\r\n                    <div style={{\r\n                        width: '80px',\r\n                        height: '80px',\r\n                        borderRadius: '50%',\r\n                        border: '3px solid rgba(0, 242, 255, 0.1)',\r\n                        borderTop: '3px solid var(--primary)',\r\n                        borderRight: '3px solid var(--accent)',\r\n                        animation: 'spin 1s linear infinite',\r\n                        boxShadow: '0 0 30px rgba(0, 242, 255, 0.3)'\r\n                    }} />\r\n\r\n                    {/* Testo principale */}\r\n                    <div style={{ textAlign: 'center' }}>\r\n                        <h2 style={{\r\n                            fontSize: '1.8rem',\r\n                            color: 'var(--primary)',\r\n                            marginBottom: '0.5rem',\r\n                            textShadow: '0 0 20px rgba(0, 242, 255, 0.5)',\r\n                            transition: 'all 0.3s ease'\r\n                        }}>\r\n                            {loadingMessage}\r\n                        </h2>\r\n\r\n                        <p style={{ color: 'var(--text-muted)', fontSize: '0.9rem' }}>\r\n                            L'IA sta elaborando proposte uniche per il tuo {genre || 'libro'}...\r\n                        </p>\r\n                    </div>\r\n\r\n                    {/* Barra progresso decorativa */}\r\n                    <div style={{\r\n                        width: '300px',\r\n                        height: '4px',\r\n                        background: 'rgba(255,255,255,0.1)',\r\n                        borderRadius: '2px',\r\n                        overflow: 'hidden'\r\n                    }}>\r\n                        <div style={{\r\n                            height: '100%',\r\n                            width: '50%',\r\n                            background: 'linear-gradient(90deg, transparent, var(--primary), transparent)',\r\n                            borderRadius: '2px',\r\n                            animation: 'shimmer 1.5s infinite linear'\r\n                        }} />\r\n                    </div>\r\n\r\n                    <p style={{\r\n                        color: 'var(--text-muted)',\r\n                        fontSize: '0.8rem',\r\n                        maxWidth: '400px',\r\n                        textAlign: 'center',\r\n                        opacity: 0.6\r\n                    }}>\r\n                        Non chiudere questa finestra. La generazione pu├▓ richiedere fino a un minuto.\r\n                    </p>\r\n                </div>\r\n            )}\r\n\r\n            <div className=\"container-narrow fade-in\" style={{ paddingTop: '2rem', minHeight: '90vh', display: 'flex', flexDirection: 'column' }}>\r\n\r\n                <div style={{ display: 'flex', gap: '0.8rem', marginBottom: '2rem', justifyContent: 'center', flexShrink: 0 }}>\r\n                    {[1, 2, 3, 4].map((step) => (\r\n                        <motion.div\r\n                            key={step}\r\n                            initial={false}\r\n                            animate={{\r\n                                width: step === 1 ? '60px' : '40px',\r\n                                background: step === 1 ? 'var(--primary)' : 'rgba(255,255,255,0.05)',\r\n                                boxShadow: step === 1 ? '0 0 15px rgba(0, 242, 255, 0.3)' : 'none'\r\n                            }}\r\n                            style={{ height: '5px', borderRadius: '10px' }}\r\n                        />\r\n                    ))}\r\n                </div>\r\n\r\n                <header style={{ marginBottom: '3rem', textAlign: 'center', flexShrink: 0 }}>\r\n                    <h1 style={{ fontSize: '2.5rem', marginBottom: '1rem', letterSpacing: '-0.05em' }}>\r\n                        {genre ? `Il tuo ${genre}` : 'La tua storia'}\r\n                    </h1>\r\n                    <p style={{ color: 'var(--text-muted)', fontSize: '1.2rem', maxWidth: '600px', margin: '0 auto' }}>\r\n                        Rispondi ad almeno 4 domande chiave e carica i tuoi bozzetti per permettere all'IA di generare la struttura del tuo libro.\r\n                    </p>\r\n                </header>\r\n\r\n                {concepts.length > 0 ? (\r\n                    <div style={{ display: 'grid', gridTemplateColumns: 'repeat(auto-fit, minmax(280px, 1fr))', gap: '2rem', padding: '1rem' }}>\r\n                        {concepts.map((concept, index) => (\r\n                            <motion.div\r\n                                key={concept.id}\r\n                                initial={{ opacity: 0, scale: 0.9 }}\r\n                                animate={{ opacity: 1, scale: 1 }}\r\n                                transition={{ delay: index * 0.1, duration: 0.5 }}\r\n                                className=\"glass-panel\"\r\n                                style={{\r\n                                    padding: '2.5rem',\r\n                                    cursor: 'pointer',\r\n                                    display: 'flex',\r\n                                    flexDirection: 'column',\r\n                                    justifyContent: 'space-between',\r\n                                    minHeight: '320px'\r\n                                }}\r\n                                whileHover={{ y: -10, borderColor: 'rgba(0, 242, 255, 0.4)', boxShadow: '0 20px 40px rgba(0, 0, 0, 0.5)' }}\r\n                                onClick={() => selectConcept(concept)}\r\n                            >\r\n                                <div>\r\n                                    <div style={{\r\n                                        background: 'rgba(0, 242, 255, 0.05)',\r\n                                        color: 'var(--primary)',\r\n                                        padding: '0.5rem 1rem',\r\n                                        borderRadius: '12px',\r\n                                        fontSize: '0.75rem',\r\n                                        fontWeight: 800,\r\n                                        display: 'inline-block',\r\n                                        marginBottom: '1.5rem',\r\n                                        border: '1px solid rgba(0, 242, 255, 0.1)',\r\n                                        letterSpacing: '0.05em'\r\n                                    }}>\r\n                                        {concept.style.toUpperCase()}\r\n                                    </div>\r\n                                    <h3 style={{ fontSize: '1.8rem', marginBottom: '1.2rem', lineHeight: 1.2 }}>{concept.title}</h3>\r\n                                    <p style={{ color: 'var(--text-muted)', lineHeight: 1.7, fontSize: '0.95rem' }}>{concept.description}</p>\r\n                                </div>\r\n                                <div style={{ marginTop: '2rem', display: 'flex', alignItems: 'center', color: 'var(--primary)', fontWeight: 700 }}>\r\n                                    Seleziona questo <ArrowRight size={18} style={{ marginLeft: 'auto' }} />\r\n                                </div>\r\n                            </motion.div>\r\n                        ))}\r\n                    </div>\r\n                ) : (\r\n                    <div style={{ display: 'flex', flexDirection: 'column', gap: '3rem', paddingBottom: '4rem' }}>\r\n\r\n                        {/* SEZIONE DATI AUTORE */}\r\n                        <motion.div\r\n                            initial={{ opacity: 0, y: 20 }}\r\n                            animate={{ opacity: 1, y: 0 }}\r\n                            className=\"glass-panel\"\r\n                            style={{ padding: '2rem', borderLeft: '4px solid var(--primary)' }}\r\n                        >\r\n                            <h4 style={{ fontSize: '1.2rem', marginBottom: '1.5rem', display: 'flex', alignItems: 'center', gap: '0.5rem' }}>\r\n                                <User size={20} color=\"var(--primary)\" />\r\n                                Dati Autore\r\n                            </h4>\r\n                            <div style={{ display: 'grid', gridTemplateColumns: '1fr 1fr', gap: '2rem' }}>\r\n                                <div>\r\n                                    <label style={{ display: 'block', marginBottom: '0.5rem', color: 'var(--text-muted)', fontSize: '0.9rem' }}>Nome Completo (obbligatorio)</label>\r\n                                    <input\r\n                                        type=\"text\"\r\n                                        value={authorName}\r\n                                        onChange={(e) => setAuthorName(e.target.value)}\r\n                                        placeholder=\"Es. Mario Rossi\"\r\n                                        style={{\r\n                                            width: '100%',\r\n                                            padding: '0.8rem',\r\n                                            background: 'rgba(0,0,0,0.2)',\r\n                                            border: '1px solid rgba(255,255,255,0.1)',\r\n                                            borderRadius: '8px',\r\n                                            color: 'var(--text-main)'\r\n                                        }}\r\n                                    />\r\n                                </div>\r\n                                <div>\r\n                                    <label style={{ display: 'block', marginBottom: '0.5rem', color: 'var(--text-muted)', fontSize: '0.9rem' }}>Pseudonimo (opzionale)</label>\r\n                                    <input\r\n                                        type=\"text\"\r\n                                        value={pseudonym}\r\n                                        onChange={(e) => setPseudonym(e.target.value)}\r\n                                        placeholder=\"Es. J.K. Writer\"\r\n                                        style={{\r\n                                            width: '100%',\r\n                                            padding: '0.8rem',\r\n                                            background: 'rgba(0,0,0,0.2)',\r\n                                            border: '1px solid rgba(255,255,255,0.1)',\r\n                                            borderRadius: '8px',\r\n                                            color: 'var(--text-main)'\r\n                                        }}\r\n                                    />\r\n                                </div>\r\n                            </div>\r\n                        </motion.div>\r\n\r\n                        {/* SEZIONE UPLOAD MATERIALI */}\r\n                        <motion.div\r\n                            initial={{ opacity: 0, y: 20 }}\r\n                            animate={{ opacity: 1, y: 0 }}\r\n                            transition={{ delay: 0.1 }}\r\n                            className=\"glass-panel\"\r\n                            style={{ padding: '2rem', borderLeft: '4px solid var(--accent)' }}\r\n                        >\r\n                            <h4 style={{ fontSize: '1.2rem', marginBottom: '1rem', display: 'flex', alignItems: 'center', gap: '0.5rem' }}>\r\n                                <FileText size={20} color=\"var(--accent)\" />\r\n                                Materiali e Bozze (Opzionale)\r\n                            </h4>\r\n                            <p style={{ color: 'var(--text-muted)', marginBottom: '1.5rem', fontSize: '0.95rem' }}>\r\n                                Carica un file Word (.docx) o testo (.txt) con appunti, storie personali, o bozze.\r\n                                L'IA user├á questi contenuti per personalizzare il libro. Max 150 pagine (5MB).\r\n                            </p>\r\n\r\n                            <div style={{ display: 'flex', alignItems: 'center', gap: '1.5rem', flexWrap: 'wrap' }}>\r\n                                <label style={{\r\n                                    display: 'flex',\r\n                                    alignItems: 'center',\r\n                                    gap: '0.8rem',\r\n                                    background: 'rgba(255,255,255,0.05)',\r\n                                    padding: '1rem 2rem',\r\n                                    borderRadius: '12px',\r\n                                    cursor: 'pointer',\r\n                                    border: '1px dashed rgba(255,255,255,0.2)',\r\n                                    transition: 'all 0.2s ease'\r\n                                }}>\r\n                                    <Upload size={20} />\r\n                                    <span>{fileName || 'Seleziona File Word/Txt'}</span>\r\n                                    <input\r\n                                        type=\"file\"\r\n                                        accept=\".docx,.txt\"\r\n                                        onChange={handleFileUpload}\r\n                                        style={{ display: 'none' }}\r\n                                        disabled={isAnalyzingFile}\r\n                                    />\r\n                                </label>\r\n\r\n                                {isAnalyzingFile && (\r\n                                    <div style={{ display: 'flex', alignItems: 'center', gap: '0.5rem', color: 'var(--text-muted)' }}>\r\n                                        <Loader2 className=\"animate-spin\" size={18} />\r\n                                        <span>Analisi file...</span>\r\n                                    </div>\r\n                                )}\r\n\r\n                                {fileError && (\r\n                                    <div style={{ display: 'flex', alignItems: 'center', gap: '0.5rem', color: 'var(--error)' }}>\r\n                                        <AlertCircle size={18} />\r\n                                        <span>{fileError}</span>\r\n                                    </div>\r\n                                )}\r\n\r\n                                {fileName && !isAnalyzingFile && !fileError && (\r\n                                    <span style={{ color: 'var(--success)', fontWeight: 600 }}>File caricato e pronto!</span>\r\n                                )}\r\n                            </div>\r\n                        </motion.div>\r\n\r\n                        <div style={{ display: 'grid', gridTemplateColumns: '1fr 1fr', gap: '2rem' }}>\r\n                            {questions.map((q, i) => (\r\n                                <motion.div\r\n                                    key={i}\r\n                                    initial={{ opacity: 0, y: 20 }}\r\n                                    animate={{ opacity: 1, y: 0 }}\r\n                                    transition={{ delay: 0.2 + (i * 0.1) }}\r\n                                    className=\"glass-panel\"\r\n                                    style={{ padding: '2rem', display: 'flex', flexDirection: 'column', gap: '1.2rem' }}\r\n                                >\r\n                                    <div style={{ display: 'flex', alignItems: 'center', gap: '1rem' }}>\r\n                                        <span style={{\r\n                                            width: '32px',\r\n                                            height: '32px',\r\n                                            minWidth: '32px',\r\n                                            minHeight: '32px',\r\n                                            flexShrink: 0,\r\n                                            aspectRatio: '1 / 1',\r\n                                            borderRadius: '50%',\r\n                                            background: 'rgba(0, 242, 255, 0.1)',\r\n                                            color: 'var(--primary)',\r\n                                            display: 'flex',\r\n                                            alignItems: 'center',\r\n                                            justifyContent: 'center',\r\n                                            fontSize: '0.9rem',\r\n                                            fontWeight: 800,\r\n                                            border: '1px solid rgba(0, 242, 255, 0.2)'\r\n                                        }}>\r\n                                            {i + 1}\r\n                                        </span>\r\n                                        <h4 style={{ fontSize: '1.1rem', fontWeight: 600 }}>{q}</h4>\r\n                                    </div>\r\n                                    <div style={{ position: 'relative' }}>\r\n                                        <textarea\r\n                                            value={answers[i]}\r\n                                            onChange={(e) => handleAnswerChange(i, e.target.value.slice(0, 200))}\r\n                                            placeholder=\"Scrivi qui la tua idea (max 200 caratteri)...\"\r\n                                            maxLength={200}\r\n                                            style={{\r\n                                                width: '100%',\r\n                                                minHeight: '120px',\r\n                                                resize: 'none',\r\n                                                background: 'rgba(0, 0, 0, 0.2)',\r\n                                                border: '1px solid rgba(255, 255, 255, 0.05)',\r\n                                                borderRadius: '16px',\r\n                                                padding: '1.2rem',\r\n                                                paddingBottom: '2rem',\r\n                                                fontSize: '1rem',\r\n                                                lineHeight: 1.5,\r\n                                                color: 'var(--text-main)'\r\n                                            }}\r\n                                        />\r\n                                        <div style={{\r\n                                            position: 'absolute',\r\n                                            bottom: '10px',\r\n                                            right: '15px',\r\n                                            fontSize: '0.75rem',\r\n                                            color: answers[i].length >= 180 ? 'var(--error)' : 'var(--text-muted)',\r\n                                            fontWeight: 600\r\n                                        }}>\r\n                                            {answers[i].length} / 200\r\n                                        </div>\r\n                                    </div>\r\n                                </motion.div>\r\n                            ))}\r\n                        </div>\r\n\r\n                        <div style={{ textAlign: 'center' }}>\r\n                            <motion.button\r\n                                whileHover={isComplete ? { scale: 1.05 } : {}}\r\n                                whileTap={isComplete ? { scale: 0.95 } : {}}\r\n                                onClick={handleGenerateConcepts}\r\n                                className=\"btn-primary\"\r\n                                disabled={loading || !isComplete}\r\n                                style={{\r\n                                    padding: '1.5rem 4rem',\r\n                                    fontSize: '1.2rem',\r\n                                    gap: '1rem',\r\n                                }}\r\n                            >\r\n                                {loading ? (\r\n                                    <>\r\n                                        <Loader2 className=\"animate-spin\" size={24} />\r\n                                        Generazione in corso...\r\n                                    </>\r\n                                ) : (\r\n                                    <>\r\n                                        <Sparkles size={24} />\r\n                                        Genera Proposte di Concept\r\n                                    </>\r\n                                )}\r\n                            </motion.button>\r\n                            {!isComplete && (\r\n                                <p style={{ color: 'var(--text-muted)', marginTop: '1.5rem', fontSize: '0.9rem' }}>\r\n                                    Rispondi ad almeno 4 domande e inserisci il nome autore per procedere\r\n                                </p>\r\n                            )}\r\n                        </div>\r\n                    </div>\r\n                )}\r\n            </div>\r\n        </>\r\n    );\r\n};\r\n\r\nexport default ConceptPage;","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\genco\\Desktop\\lavoro\\w4uN8N\\src\\pages\\wizard\\ConfigurationPage.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\genco\\Desktop\\lavoro\\w4uN8N\\src\\pages\\wizard\\CoverPage.tsx","messages":[{"ruleId":"react-hooks/exhaustive-deps","severity":1,"message":"React Hook useEffect has a missing dependency: 'fetchBookData'. Either include it or remove the dependency array.","line":58,"column":8,"nodeType":"ArrayExpression","endLine":58,"endColumn":26,"suggestions":[{"desc":"Update the dependencies array to be: [bookId, coverUrl, fetchBookData]","fix":{"range":[2338,2356],"text":"[bookId, coverUrl, fetchBookData]"}}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import React, { useState, useEffect } from 'react';\r\nimport { useNavigate } from 'react-router-dom';\r\nimport { Image, ChevronRight, Loader2, Wand2, Download, CheckCircle, Type } from 'lucide-react';\r\nimport { supabase, logDebug, callBookAgent } from '../../lib/api';\r\nimport { motion } from 'framer-motion';\r\n\r\nconst CoverPage: React.FC = () => {\r\n    const navigate = useNavigate();\r\n    const [generating, setGenerating] = useState(false);\r\n    const [coverUrl, setCoverUrl] = useState<string | null>(null);\r\n    const [bookTitle, setBookTitle] = useState('');\r\n    const [bookAuthor, setBookAuthor] = useState('');\r\n    const [mood, setMood] = useState('captivating and professional');\r\n    const [style, setStyle] = useState('modern literary fiction');\r\n    const [loading, setLoading] = useState(true);\r\n    const [progressStage, setProgressStage] = useState<string>('');\r\n\r\n    // Overlay State\r\n    const [showOverlay, setShowOverlay] = useState(true);\r\n    const [titleColor, setTitleColor] = useState('#ffffff');\r\n    const [titleFont, setTitleFont] = useState('Cinzel');\r\n    const [overlayShadow, setOverlayShadow] = useState(true);\r\n\r\n    const bookId = localStorage.getItem('active_book_id');\r\n\r\n    useEffect(() => {\r\n        if (!bookId) {\r\n            setLoading(false);\r\n            return;\r\n        }\r\n        fetchBookData();\r\n\r\n        // Realtime subscription for async cover generation\r\n        const channel = supabase\r\n            .channel(`book-cover-${bookId}`)\r\n            .on(\r\n                'postgres_changes',\r\n                {\r\n                    event: 'UPDATE',\r\n                    schema: 'public',\r\n                    table: 'books',\r\n                    filter: `id=eq.${bookId}`\r\n                },\r\n                (payload: { new: { cover_url: string } }) => {\r\n                    const newBook = payload.new;\r\n                    if (newBook.cover_url && newBook.cover_url !== coverUrl) {\r\n                        setCoverUrl(newBook.cover_url);\r\n                        setGenerating(false);\r\n                        logDebug('frontend', 'cover_generation_realtime_received', { url: newBook.cover_url }, bookId);\r\n                    }\r\n                }\r\n            )\r\n            .subscribe();\r\n\r\n        return () => {\r\n            supabase.removeChannel(channel);\r\n        };\r\n    }, [bookId, coverUrl]);\r\n\r\n    const fetchBookData = async () => {\r\n        try {\r\n            const { data, error } = await supabase\r\n                .from('books')\r\n                .select('title, author, cover_url, genre, context_data')\r\n                .eq('id', bookId)\r\n                .single();\r\n\r\n            if (error) throw error;\r\n            if (data) {\r\n                setBookTitle(data.title || 'Il tuo libro');\r\n                setBookAuthor(data.author || 'Autore');\r\n                if (data.cover_url) {\r\n                    setCoverUrl(data.cover_url);\r\n                }\r\n\r\n                // Try to extract mood/style from blueprint if present\r\n                const blueprint = data.context_data?.blueprint;\r\n                if (blueprint) {\r\n                    if (blueprint.plot_vibes) setMood(blueprint.plot_vibes);\r\n                }\r\n\r\n                // Set default style based on genre\r\n                const genreStyles: Record<string, string> = {\r\n                    'Giallo e Thriller': 'dark suspenseful cinematic mystery',\r\n                    'Fantasy': 'epic high-fantasy digital art magical',\r\n                    'Romance': 'soft romantic pastel watercolor emotion',\r\n                    'Sci-Fi': 'futuristic neon sci-fi concept art high-tech',\r\n                    'Horror': 'eerie macabre gothic horror dark',\r\n                    'Storico': 'historical oil painting realistic vintage',\r\n                    'Young Adult': 'modern vibrant digital notebook style',\r\n                    'Distopico': 'grim dystopian cyberpunk oppressive atmosphere',\r\n                    'Avventura': 'action dynamic landscape cinematic lighting',\r\n                    'Business & Self-Help': 'minimalist clean professional corporate',\r\n                    'Salute, Dieta e Benessere': 'fresh organic bright natural photography',\r\n                    'Finanza Personale e Investimenti': 'professional data-driven clean geometric',\r\n                    'Hobby e Passioni': 'warm inviting detailed hobbyist workshop',\r\n                    'Spiritualit├á e New Age': 'ethereal spiritual mystical light nebula',\r\n                    'Relazioni e Parenting': 'warm family connection emotional photography',\r\n                    'Tecnologia e AI': 'digital circuit abstract modern tech neural',\r\n                    'Viaggi e Guide di Nicchia': 'travel photography scenic landscape vivid',\r\n                    'Biografie e Memorie': 'black and white portrait classic elegant',\r\n                    'Saggistica Scientifica o Storica': 'educational schematic detailed illustration'\r\n                };\r\n                if (data.genre && genreStyles[data.genre]) {\r\n                    setStyle(genreStyles[data.genre]);\r\n                }\r\n            }\r\n        } catch (err) {\r\n            console.error('Error fetching book data:', err);\r\n        } finally {\r\n            setLoading(false);\r\n        }\r\n    };\r\n\r\n    const generateCover = async () => {\r\n        if (!bookId) return;\r\n\r\n        setGenerating(true);\r\n        setProgressStage('Analisi blueprint e preparazione prompt...');\r\n        const startTime = performance.now();\r\n        try {\r\n            await logDebug('frontend', 'cover_generation_start', {\r\n                bookId,\r\n                mood,\r\n                style,\r\n                is_regenerate: !!coverUrl\r\n            }, bookId);\r\n\r\n            // Call the book agent to generate cover\r\n            setProgressStage('Generazione con DALL-E 3 (pu├▓ richiedere fino a 60s)...');\r\n            const response = await callBookAgent('GENERATE_COVER', {\r\n                title: bookTitle,\r\n                author: bookAuthor,\r\n                mood: mood,\r\n                style: style\r\n            }, bookId);\r\n\r\n            setProgressStage('Finalizzazione e salvataggio...');\r\n\r\n            if (response && response.status === 'started') {\r\n                console.log('Cover generation started async');\r\n                // Do nothing, wait for Realtime\r\n            } else if (response && response.cover_url) {\r\n                setCoverUrl(response.cover_url);\r\n                await supabase\r\n                    .from('books')\r\n                    .update({ cover_url: response.cover_url })\r\n                    .eq('id', bookId);\r\n\r\n                await logDebug('frontend', 'cover_generation_success_sync', {\r\n                    bookId,\r\n                    coverUrl: response.cover_url,\r\n                    duration_ms: Math.round(performance.now() - startTime)\r\n                }, bookId);\r\n                setGenerating(false);\r\n            }\r\n        } catch (err: unknown) {\r\n            const error = err as Error;\r\n            console.error('Cover generation error:', error);\r\n            await logDebug('frontend', 'cover_generation_error', {\r\n                error: error.message,\r\n                bookId,\r\n                duration_ms: Math.round(performance.now() - startTime)\r\n            }, bookId);\r\n            setGenerating(false);\r\n            if (error.message && error.message.includes('timeout')) {\r\n                alert('La generazione sta richiedendo pi├╣ tempo del previsto. L\\'immagine apparir├á qui appena pronta.');\r\n            } else {\r\n                alert('Errore durante la generazione. Verifica i crediti o riprova tra poco.');\r\n            }\r\n        }\r\n    };\r\n\r\n    const downloadCover = async () => {\r\n        if (!coverUrl) return;\r\n        // NOTE: Downloading just the image. To download with text, we'd need canvas composition.\r\n        // For now, we rely on the user taking the image and ensuring the text is part of their final layout elsewhere if needed,\r\n        // or this is just for preview.\r\n        try {\r\n            const response = await fetch(coverUrl);\r\n            const blob = await response.blob();\r\n            const url = window.URL.createObjectURL(blob);\r\n            const a = document.createElement('a');\r\n            a.href = url;\r\n            a.download = `${bookTitle.replace(/[^a-z0-9]/gi, '_').toLowerCase()}_cover.png`;\r\n            document.body.appendChild(a);\r\n            a.click();\r\n            window.URL.revokeObjectURL(url);\r\n            document.body.removeChild(a);\r\n        } catch (e) {\r\n            console.error('Download failed, falling back to new tab', e);\r\n            window.open(coverUrl, '_blank');\r\n        }\r\n    };\r\n\r\n    const proceedToExport = async () => {\r\n        if (bookId) {\r\n            await supabase.from('books').update({ status: 'EXPORT' }).eq('id', bookId);\r\n        }\r\n        navigate('/create/export');\r\n    };\r\n\r\n    if (loading) {\r\n        return (\r\n            <div style={{ height: '100%', display: 'flex', alignItems: 'center', justifyContent: 'center' }}>\r\n                <Loader2 className=\"animate-spin\" size={48} color=\"var(--primary)\" />\r\n            </div>\r\n        );\r\n    }\r\n\r\n    return (\r\n        <div className=\"container-narrow fade-in\" style={{ textAlign: 'center', paddingTop: '2rem' }}>\r\n            <h1 style={{ fontSize: '2.5rem', marginBottom: '1rem' }}>Genera la Copertina</h1>\r\n            <p style={{ color: 'var(--text-muted)', marginBottom: '3rem', fontSize: '1.2rem' }}>\r\n                Crea una copertina professionale per il tuo libro prima dell'export.\r\n            </p>\r\n\r\n            <div style={{ display: 'grid', gridTemplateColumns: '1fr 1fr', gap: '3rem', maxWidth: '900px', margin: '0 auto' }}>\r\n                {/* Left: Cover Preview */}\r\n                <div className=\"glass-panel\" style={{ padding: '2rem', display: 'flex', flexDirection: 'column', alignItems: 'center' }}>\r\n                    <h3 style={{ fontSize: '1.2rem', marginBottom: '1.5rem', color: 'var(--text-muted)' }}>Anteprima Copertina</h3>\r\n\r\n                    <div style={{ position: 'relative' }}>\r\n                        {coverUrl ? (\r\n                            <motion.div\r\n                                initial={{ scale: 0.9, opacity: 0 }}\r\n                                animate={{ scale: 1, opacity: 1 }}\r\n                                style={{\r\n                                    width: '320px',\r\n                                    height: '480px',\r\n                                    borderRadius: '8px',\r\n                                    overflow: 'hidden',\r\n                                    boxShadow: '0 25px 50px -12px rgba(0,0,0,0.5)',\r\n                                    border: '1px solid rgba(255,255,255,0.2)',\r\n                                    position: 'relative'\r\n                                }}\r\n                            >\r\n                                <img\r\n                                    src={coverUrl}\r\n                                    alt=\"Copertina del libro\"\r\n                                    style={{ width: '100%', height: '100%', objectFit: 'cover' }}\r\n                                />\r\n                                {/* HTML TEXT OVERLAY */}\r\n                                {showOverlay && (\r\n                                    <div style={{\r\n                                        position: 'absolute',\r\n                                        inset: 0,\r\n                                        display: 'flex',\r\n                                        flexDirection: 'column',\r\n                                        justifyContent: 'space-between',\r\n                                        padding: '2rem',\r\n                                        textAlign: 'center',\r\n                                        textShadow: overlayShadow ? '0 2px 10px rgba(0,0,0,0.8)' : 'none'\r\n                                    }}>\r\n                                        <div style={{ marginTop: '2rem' }}>\r\n                                            <h1 style={{\r\n                                                fontFamily: titleFont,\r\n                                                color: titleColor,\r\n                                                fontSize: '2.5rem',\r\n                                                lineHeight: 1.1,\r\n                                                textTransform: 'uppercase',\r\n                                                letterSpacing: '0.05em'\r\n                                            }}>\r\n                                                {bookTitle}\r\n                                            </h1>\r\n                                        </div>\r\n                                        <div style={{ marginBottom: '2rem' }}>\r\n                                            <p style={{\r\n                                                fontFamily: 'Montserrat, sans-serif',\r\n                                                color: titleColor,\r\n                                                fontSize: '1.1rem',\r\n                                                fontWeight: 600,\r\n                                                letterSpacing: '0.2em',\r\n                                                textTransform: 'uppercase',\r\n                                                opacity: 0.9\r\n                                            }}>\r\n                                                {bookAuthor}\r\n                                            </p>\r\n                                        </div>\r\n                                    </div>\r\n                                )}\r\n                            </motion.div>\r\n                        ) : (\r\n                            <div style={{\r\n                                width: '320px',\r\n                                height: '480px',\r\n                                borderRadius: '8px',\r\n                                background: 'linear-gradient(135deg, #4f46e5 0%, #0f172a 100%)',\r\n                                boxShadow: '0 25px 50px -12px rgba(0,0,0,0.5)',\r\n                                border: '1px solid rgba(255,255,255,0.2)',\r\n                                display: 'flex',\r\n                                flexDirection: 'column',\r\n                                alignItems: 'center',\r\n                                justifyContent: 'center',\r\n                                color: 'white',\r\n                                textAlign: 'center',\r\n                                padding: '2rem'\r\n                            }}>\r\n                                <Image size={64} style={{ marginBottom: '1rem', opacity: 0.7 }} />\r\n                                <h2 style={{ fontSize: '1.5rem', fontWeight: 700, marginBottom: '0.5rem' }}>{bookTitle}</h2>\r\n                                <p style={{ fontSize: '1rem', opacity: 0.8 }}>di {bookAuthor}</p>\r\n                            </div>\r\n                        )}\r\n                    </div>\r\n\r\n                    {coverUrl && (\r\n                        <motion.div\r\n                            initial={{ opacity: 0, y: 10 }}\r\n                            animate={{ opacity: 1, y: 0 }}\r\n                            style={{\r\n                                display: 'flex',\r\n                                alignItems: 'center',\r\n                                gap: '0.5rem',\r\n                                marginTop: '1rem',\r\n                                color: 'var(--success)'\r\n                            }}\r\n                        >\r\n                            <CheckCircle size={20} />\r\n                            <span>Copertina generata con successo!</span>\r\n                        </motion.div>\r\n                    )}\r\n                </div>\r\n\r\n                {/* Right: Controls */}\r\n                <div className=\"glass-panel\" style={{ padding: '2rem', display: 'flex', flexDirection: 'column', justifyContent: 'space-between' }}>\r\n                    <div>\r\n                        <h3 style={{ fontSize: '1.2rem', marginBottom: '1.5rem', color: 'var(--text-muted)' }}>Generazione Copertina</h3>\r\n\r\n                        <div style={{ textAlign: 'left', marginBottom: '2rem' }}>\r\n                            <div style={{ marginBottom: '1.5rem' }}>\r\n                                <label style={{ display: 'block', marginBottom: '0.5rem', color: 'var(--text-muted)', fontSize: '0.9rem' }}>Atmosfera (Mood)</label>\r\n                                <input\r\n                                    value={mood}\r\n                                    onChange={(e) => setMood(e.target.value)}\r\n                                    placeholder=\"Es. misteriosa, epica, romantica...\"\r\n                                    style={{ width: '100%', padding: '0.8rem', borderRadius: '8px', background: 'rgba(0,0,0,0.2)', border: '1px solid var(--glass-border)', color: 'white' }}\r\n                                />\r\n                            </div>\r\n\r\n                            <div style={{ marginBottom: '1.5rem' }}>\r\n                                <label style={{ display: 'block', marginBottom: '0.5rem', color: 'var(--text-muted)', fontSize: '0.9rem' }}>Stile Artistico</label>\r\n                                <input\r\n                                    value={style}\r\n                                    onChange={(e) => setStyle(e.target.value)}\r\n                                    placeholder=\"Es. pittura a olio, minimalista, cyberpunk...\"\r\n                                    style={{ width: '100%', padding: '0.8rem', borderRadius: '8px', background: 'rgba(0,0,0,0.2)', border: '1px solid var(--glass-border)', color: 'white' }}\r\n                                />\r\n                            </div>\r\n\r\n                            {/* OVERLAY CONTROLS */}\r\n                            <div style={{ borderTop: '1px solid var(--glass-border)', paddingTop: '1.5rem', marginTop: '1.5rem' }}>\r\n                                <div style={{ display: 'flex', alignItems: 'center', justifyContent: 'space-between', marginBottom: '1rem', cursor: 'pointer' }} onClick={() => setShowOverlay(!showOverlay)}>\r\n                                    <label style={{ display: 'flex', alignItems: 'center', gap: '0.5rem', color: 'var(--text-main)', fontWeight: 600, cursor: 'pointer' }}>\r\n                                        <Type size={16} /> Sovrapponi Testo\r\n                                    </label>\r\n                                    <div style={{\r\n                                        width: '36px', height: '20px', background: showOverlay ? 'var(--primary)' : 'var(--bg-disabled)',\r\n                                        borderRadius: '20px', position: 'relative', transition: 'all 0.3s'\r\n                                    }}>\r\n                                        <div style={{\r\n                                            position: 'absolute', width: '16px', height: '16px', background: 'white', borderRadius: '50%',\r\n                                            top: '2px', left: showOverlay ? '18px' : '2px', transition: 'all 0.3s'\r\n                                        }} />\r\n                                    </div>\r\n                                </div>\r\n\r\n                                {showOverlay && (\r\n                                    <motion.div initial={{ opacity: 0, height: 0 }} animate={{ opacity: 1, height: 'auto' }}>\r\n                                        <div style={{ display: 'flex', gap: '0.5rem', marginBottom: '1rem' }}>\r\n                                            <button onClick={() => setTitleColor('#ffffff')} style={{ width: '24px', height: '24px', borderRadius: '50%', background: '#ffffff', border: titleColor === '#ffffff' ? '2px solid var(--primary)' : '1px solid #ccc' }} title=\"White\" />\r\n                                            <button onClick={() => setTitleColor('#000000')} style={{ width: '24px', height: '24px', borderRadius: '50%', background: '#000000', border: titleColor === '#000000' ? '2px solid var(--primary)' : '1px solid #ccc' }} title=\"Black\" />\r\n                                            <button onClick={() => setTitleColor('#FFD700')} style={{ width: '24px', height: '24px', borderRadius: '50%', background: '#FFD700', border: titleColor === '#FFD700' ? '2px solid var(--primary)' : '1px solid #ccc' }} title=\"Gold\" />\r\n\r\n                                            <div style={{ width: '1px', background: 'var(--glass-border)', margin: '0 0.5rem' }} />\r\n\r\n                                            <select\r\n                                                value={titleFont}\r\n                                                onChange={(e) => setTitleFont(e.target.value)}\r\n                                                style={{ padding: '0.2rem', fontSize: '0.8rem', background: 'transparent', border: '1px solid var(--glass-border)', color: 'white' }}\r\n                                            >\r\n                                                <option value=\"Cinzel\">Cinzel (Fantasy)</option>\r\n                                                <option value=\"Playfair Display\">Playfair (Elegant)</option>\r\n                                                <option value=\"Montserrat\">Montserrat (Modern)</option>\r\n                                                <option value=\"Inter\">Inter (Clean)</option>\r\n                                            </select>\r\n                                        </div>\r\n                                        <label style={{ display: 'flex', alignItems: 'center', gap: '0.5rem', fontSize: '0.8rem', color: 'var(--text-muted)' }}>\r\n                                            <input type=\"checkbox\" checked={overlayShadow} onChange={(e) => setOverlayShadow(e.target.checked)} />\r\n                                            Ombreggiatura testo\r\n                                        </label>\r\n                                    </motion.div>\r\n                                )}\r\n                            </div>\r\n                        </div>\r\n\r\n                        <button\r\n                            onClick={generateCover}\r\n                            disabled={generating}\r\n                            className=\"btn-primary\"\r\n                            style={{ width: '100%', marginBottom: '1rem' }}\r\n                        >\r\n                            {generating ? (\r\n                                <>\r\n                                    <Loader2 className=\"animate-spin\" size={20} />\r\n                                    <span>{progressStage}</span>\r\n                                </>\r\n                            ) : coverUrl ? (\r\n                                <>\r\n                                    <Wand2 size={20} />\r\n                                    Rigenera Copertina\r\n                                </>\r\n                            ) : (\r\n                                <>\r\n                                    <Wand2 size={20} />\r\n                                    Genera Copertina\r\n                                </>\r\n                            )}\r\n                        </button>\r\n\r\n                        {coverUrl && (\r\n                            <button\r\n                                onClick={downloadCover}\r\n                                className=\"btn-secondary\"\r\n                                style={{ width: '100%' }}\r\n                            >\r\n                                <Download size={20} />\r\n                                Scarica Copertina (.png)\r\n                            </button>\r\n                        )}\r\n                    </div>\r\n\r\n                    <div style={{ marginTop: '2rem', paddingTop: '2rem', borderTop: '1px solid var(--glass-border)' }}>\r\n                        <button\r\n                            onClick={proceedToExport}\r\n                            className=\"btn-primary\"\r\n                            style={{ width: '100%' }}\r\n                        >\r\n                            Procedi all'Export\r\n                            <ChevronRight size={20} />\r\n                        </button>\r\n                        <p style={{ fontSize: '0.75rem', color: 'var(--text-muted)', textAlign: 'center', marginTop: '1rem' }}>\r\n                            Puoi procedere all'export anche senza generare una copertina.\r\n                        </p>\r\n                    </div>\r\n                </div>\r\n            </div>\r\n        </div>\r\n    );\r\n};\r\n\r\nexport default CoverPage;\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\genco\\Desktop\\lavoro\\w4uN8N\\src\\pages\\wizard\\ExportPage.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\genco\\Desktop\\lavoro\\w4uN8N\\src\\pages\\wizard\\ProductionPage.tsx","messages":[{"ruleId":"react-hooks/exhaustive-deps","severity":1,"message":"React Hook useEffect has missing dependencies: 'fetchChapters', 'isEditing', and 'selectedChapterId'. Either include them or remove the dependency array.","line":84,"column":8,"nodeType":"ArrayExpression","endLine":84,"endColumn":16,"suggestions":[{"desc":"Update the dependencies array to be: [bookId, fetchChapters, isEditing, selectedChapterId]","fix":{"range":[3234,3242],"text":"[bookId, fetchChapters, isEditing, selectedChapterId]"}}]},{"ruleId":"react-hooks/exhaustive-deps","severity":1,"message":"React Hook useEffect has a missing dependency: 'loadingPhases'. Either include it or remove the dependency array.","line":108,"column":8,"nodeType":"ArrayExpression","endLine":108,"endColumn":36,"suggestions":[{"desc":"Update the dependencies array to be: [globalGenerating, chapters, loadingPhases]","fix":{"range":[4433,4461],"text":"[globalGenerating, chapters, loadingPhases]"}}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":2,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import React, { useState, useEffect } from 'react';\r\nimport { Play, CheckCircle2, Loader2, FileText, ChevronRight, ChevronDown, Save, Edit3 } from 'lucide-react';\r\nimport { marked } from 'marked';\r\nimport { callBookAgent, supabase } from '../../lib/api';\r\nimport { getBookTypeForGenre, getPromptsForGenre } from '../../data/genres';\r\nimport { getToneDescription, injectVariables } from '../../utils/prompt-engine';\r\n\r\ninterface DBChapter {\r\n    id: string; // UUID from DB\r\n    title: string;\r\n    summary: string;\r\n    content: string | null;\r\n    status: string;\r\n    structure: Array<{ title: string; description: string }> | null;\r\n    chapter_number: number;\r\n}\r\n\r\nconst ProductionPage: React.FC = () => {\r\n\r\n    const [chapters, setChapters] = useState<DBChapter[]>([]);\r\n    const [selectedChapterId, setSelectedChapterId] = useState<string | null>(null);\r\n    const [expandedChapters, setExpandedChapters] = useState<Set<string>>(new Set());\r\n\r\n    // Editor State\r\n    const [isEditing, setIsEditing] = useState(false);\r\n    const [editorContent, setEditorContent] = useState(\"\");\r\n    const [saving, setSaving] = useState(false);\r\n\r\n    const [globalGenerating, setGlobalGenerating] = useState(false);\r\n\r\n    // Stati per l'overlay di caricamento\r\n    const [loadingMessage, setLoadingMessage] = useState(\"Analisi del blueprint narrativo...\");\r\n    const [loadingSubMessage, setLoadingSubMessage] = useState(\"\");\r\n\r\n    const loadingPhases = [\r\n        \"Analisi del blueprint narrativo...\",\r\n        \"Sviluppo personaggi...\",\r\n        \"Costruzione ambientazione...\",\r\n        \"Scrittura dialoghi...\",\r\n        \"Controllo coerenza...\",\r\n        \"Revisione grammaticale...\",\r\n        \"Finalizzazione capitoli...\"\r\n    ];\r\n\r\n    const bookId = localStorage.getItem('active_book_id');\r\n\r\n    useEffect(() => {\r\n        if (!bookId) return;\r\n        fetchChapters();\r\n\r\n        const channel = supabase\r\n            .channel(`chapters-changes-${bookId}`)\r\n            .on(\r\n                'postgres_changes',\r\n                {\r\n                    event: '*',\r\n                    schema: 'public',\r\n                    table: 'chapters',\r\n                    filter: `book_id=eq.${bookId}`\r\n                },\r\n                (payload: unknown) => {\r\n                    const p = payload as { eventType: string; new: DBChapter };\r\n                    if (p.eventType === 'UPDATE') {\r\n                        const updated = p.new;\r\n                        setChapters(prev => prev.map(c => c.id === updated.id ? { ...c, ...updated } : c));\r\n\r\n                        // If we are viewing this chapter and it's not being edited, update content\r\n                        if (updated.id === selectedChapterId && !isEditing) {\r\n                            setEditorContent(updated.content || \"\");\r\n                        }\r\n                    }\r\n                }\r\n            )\r\n            .subscribe((status) => {\r\n                if (status === 'CHANNEL_ERROR') {\r\n                    const interval = setInterval(fetchChapters, 10000);\r\n                    return () => clearInterval(interval);\r\n                }\r\n            });\r\n\r\n        return () => {\r\n            supabase.removeChannel(channel);\r\n        }\r\n    }, [bookId]);\r\n\r\n    // Quando cambia il capitolo selezionato, aggiorna l'editor\r\n    useEffect(() => {\r\n        const current = chapters.find(c => c.id === selectedChapterId);\r\n        if (current) {\r\n            setEditorContent(current.content || \"\");\r\n            setIsEditing(false); // Reset editing mode on change? Or keep visual mode?\r\n        }\r\n    }, [selectedChapterId, chapters]);\r\n\r\n    // ... (Loading effect logic remains similar, omitted for brevity but logic is preserved if needed)\r\n    useEffect(() => {\r\n        if (!globalGenerating) return;\r\n        let phaseIndex = 0;\r\n        setLoadingMessage(loadingPhases[0]);\r\n        setLoadingSubMessage(`Preparazione generazione ${chapters.length} capitoli...`);\r\n        const interval = setInterval(() => {\r\n            phaseIndex = (phaseIndex + 1) % loadingPhases.length;\r\n            setLoadingMessage(loadingPhases[phaseIndex]);\r\n            const completed = chapters.filter(c => c.status === 'COMPLETED' || (c.content && c.content.length > 50)).length;\r\n            setLoadingSubMessage(`Progresso: ${completed}/${chapters.length} capitoli completati`);\r\n        }, 2500);\r\n        return () => clearInterval(interval);\r\n    }, [globalGenerating, chapters]);\r\n\r\n\r\n    const fetchChapters = async () => {\r\n        const { data, error } = await supabase\r\n            .from('chapters')\r\n            .select('*')\r\n            .eq('book_id', bookId)\r\n            .order('chapter_number', { ascending: true });\r\n\r\n        if (error) console.error(error);\r\n        if (data) {\r\n            setChapters(data);\r\n            if (data.length > 0 && !selectedChapterId) {\r\n                setSelectedChapterId(data[0].id);\r\n                setExpandedChapters(new Set([data[0].id]));\r\n            }\r\n        }\r\n    };\r\n\r\n    const toggleChapter = (e: React.MouseEvent, id: string) => {\r\n        e.stopPropagation();\r\n        setExpandedChapters(prev => {\r\n            const next = new Set(prev);\r\n            if (next.has(id)) next.delete(id);\r\n            else next.add(id);\r\n            return next;\r\n        });\r\n    };\r\n\r\n    const saveContent = async () => {\r\n        if (!selectedChapterId) return;\r\n        setSaving(true);\r\n        try {\r\n            await supabase\r\n                .from('chapters')\r\n                .update({ content: editorContent, status: 'COMPLETED' })\r\n                .eq('id', selectedChapterId);\r\n        } catch (e) {\r\n            console.error(e);\r\n            alert(\"Errore salvataggio\");\r\n        } finally {\r\n            setSaving(false);\r\n            setIsEditing(false);\r\n        }\r\n    };\r\n\r\n    const generateChapter = async (id: string) => {\r\n        setChapters(prev => prev.map(c => c.id === id ? { ...c, status: 'GENERATING' } : c));\r\n        try {\r\n            const { data: bookData } = await supabase.from('books').select('genre, context_data, title').eq('id', bookId).single();\r\n            const genre = bookData?.genre || '';\r\n            const config = bookData?.context_data?.configuration;\r\n\r\n            // Re-fetch prompts and logic... (Same as before)\r\n            const rawPrompts = getPromptsForGenre(genre);\r\n            const baseTemplate = rawPrompts?.WRITER || '';\r\n            const bookType = getBookTypeForGenre(genre);\r\n            const toneDesc = getToneDescription(bookType, config?.toneSerious ?? 0.5, config?.toneConcise ?? 0.5, config?.toneSimple ?? 0.5);\r\n\r\n            const currentChapter = chapters.find(c => c.id === id);\r\n            const writerPrompt = injectVariables(baseTemplate, {\r\n                bookTitle: bookData?.title || \"Senza Titolo\",\r\n                genre: genre,\r\n                tone: toneDesc,\r\n                target: config?.targets?.join(\", \") || \"Pubblico generale\",\r\n                chapterTitle: currentChapter?.title || \"Senza Titolo\",\r\n                chapterSummary: currentChapter?.summary || \"Nessun sommario disponibile\"\r\n            });\r\n\r\n            await callBookAgent('WRITE', { chapterId: id, systemPrompt: writerPrompt }, bookId);\r\n            setTimeout(() => { fetchChapters(); }, 5000);\r\n        } catch (e) {\r\n            console.error(e);\r\n            alert(\"Errore avvio generazione.\");\r\n            setChapters(prev => prev.map(c => c.id === id ? { ...c, status: 'PENDING' } : c));\r\n        }\r\n    };\r\n\r\n    const generateAll = async () => {\r\n        setGlobalGenerating(true);\r\n        const toGenerate = chapters.filter(c => !c.content || c.status === 'PENDING' || c.status === 'ERROR');\r\n        for (const chap of toGenerate) {\r\n            // Simplified logic for brevity/robustness\r\n            await generateChapter(chap.id);\r\n            await new Promise(r => setTimeout(r, 2000)); // Stagger slightly\r\n        }\r\n        setGlobalGenerating(false);\r\n    };\r\n\r\n    const currentChapter = chapters.find(c => c.id === selectedChapterId);\r\n    const completedCount = chapters.filter(c => c.status === 'COMPLETED' || (c.content && c.content.length > 50)).length;\r\n    const progress = (completedCount / Math.max(chapters.length, 1)) * 100;\r\n\r\n    return (\r\n        <div style={{ display: 'grid', gridTemplateColumns: '320px 1fr', height: '100%', gap: '1rem', overflow: 'hidden' }}>\r\n\r\n            {/* OVERLAY GENERAZIONE */}\r\n            {globalGenerating && (\r\n                <div style={{\r\n                    position: 'fixed',\r\n                    inset: 0,\r\n                    background: 'rgba(5, 5, 8, 0.95)',\r\n                    backdropFilter: 'blur(20px)',\r\n                    zIndex: 1000,\r\n                    display: 'flex',\r\n                    flexDirection: 'column',\r\n                    alignItems: 'center',\r\n                    justifyContent: 'center',\r\n                    gap: '2rem',\r\n                    animation: 'fadeIn 0.3s ease-out'\r\n                }}>\r\n                    <div style={{\r\n                        width: '80px',\r\n                        height: '80px',\r\n                        borderRadius: '50%',\r\n                        border: '3px solid rgba(0, 242, 255, 0.1)',\r\n                        borderTop: '3px solid var(--primary)',\r\n                        borderRight: '3px solid var(--accent)',\r\n                        animation: 'spin 1s linear infinite',\r\n                        boxShadow: '0 0 30px rgba(0, 242, 255, 0.3)'\r\n                    }} />\r\n\r\n                    <div style={{ textAlign: 'center' }}>\r\n                        <h2 style={{\r\n                            fontSize: '1.8rem',\r\n                            color: 'var(--primary)',\r\n                            marginBottom: '0.5rem',\r\n                            textShadow: '0 0 20px rgba(0, 242, 255, 0.5)',\r\n                            transition: 'all 0.3s ease'\r\n                        }}>\r\n                            {loadingMessage}\r\n                        </h2>\r\n\r\n                        <p style={{ color: 'var(--text-muted)', fontSize: '0.9rem' }}>\r\n                            {loadingSubMessage}\r\n                        </p>\r\n                    </div>\r\n\r\n                    <div style={{\r\n                        width: '300px',\r\n                        height: '4px',\r\n                        background: 'rgba(255,255,255,0.1)',\r\n                        borderRadius: '2px',\r\n                        overflow: 'hidden'\r\n                    }}>\r\n                        <div style={{\r\n                            height: '100%',\r\n                            width: '50%',\r\n                            background: 'linear-gradient(90deg, transparent, var(--primary), transparent)',\r\n                            borderRadius: '2px',\r\n                            animation: 'shimmer 1.5s infinite linear'\r\n                        }} />\r\n                    </div>\r\n\r\n                    <p style={{\r\n                        color: 'var(--text-muted)',\r\n                        fontSize: '0.8rem',\r\n                        maxWidth: '400px',\r\n                        textAlign: 'center',\r\n                        opacity: 0.6\r\n                    }}>\r\n                        Non chiudere questa finestra. L'IA sta scrivendo il tuo libro.\r\n                    </p>\r\n                </div>\r\n            )}\r\n\r\n            {/* SIDEBAR */}\r\n            <div className=\"glass-panel\" style={{ display: 'flex', flexDirection: 'column', overflow: 'hidden', height: '90vh' }}>\r\n                <div style={{ padding: '1rem', borderBottom: '1px solid var(--glass-border)' }}>\r\n                    <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '0.5rem' }}>\r\n                        <h2 style={{ fontSize: '1.1rem' }}>Indice</h2>\r\n                        <span style={{ fontSize: '0.8rem', color: 'var(--text-muted)' }}>{completedCount}/{chapters.length}</span>\r\n                    </div>\r\n                    <div className=\"progress-container\"><div className=\"progress-bar\" style={{ width: `${progress}%` }}></div></div>\r\n\r\n                    <button onClick={fetchChapters} className=\"btn-secondary\" style={{ width: '100%', marginTop: '1rem', fontSize: '0.8rem', padding: '0.3rem' }}>\r\n                        Aggiorna Lista\r\n                    </button>\r\n                </div>\r\n\r\n                <div style={{ flex: 1, overflowY: 'auto', padding: '0.5rem' }}>\r\n                    {chapters.map(chapter => (\r\n                        <div key={chapter.id} style={{ marginBottom: '0.5rem' }}>\r\n                            <div\r\n                                onClick={() => { setSelectedChapterId(chapter.id); if (!expandedChapters.has(chapter.id)) toggleChapter({ stopPropagation: () => { } } as unknown as React.MouseEvent, chapter.id); }}\r\n                                style={{\r\n                                    padding: '0.8rem',\r\n                                    borderRadius: '8px',\r\n                                    background: selectedChapterId === chapter.id ? 'rgba(79, 70, 229, 0.15)' : 'transparent',\r\n                                    border: selectedChapterId === chapter.id ? '1px solid var(--primary)' : '1px solid transparent',\r\n                                    cursor: 'pointer',\r\n                                    display: 'flex',\r\n                                    justifyContent: 'space-between',\r\n                                    alignItems: 'center'\r\n                                }}\r\n                            >\r\n                                <div style={{ display: 'flex', alignItems: 'center', gap: '0.5rem', overflow: 'hidden' }}>\r\n                                    <div onClick={(e: React.MouseEvent) => toggleChapter(e, chapter.id)} style={{ padding: '2px', cursor: 'pointer' }}>\r\n                                        {expandedChapters.has(chapter.id) ? <ChevronDown size={14} /> : <ChevronRight size={14} />}\r\n                                    </div>\r\n                                    <span style={{ fontWeight: 600, fontSize: '0.9rem', whiteSpace: 'nowrap', overflow: 'hidden', textOverflow: 'ellipsis' }}>\r\n                                        {chapter.chapter_number}. {chapter.title}\r\n                                    </span>\r\n                                </div>\r\n                                {chapter.status === 'GENERATING' && <Loader2 size={14} className=\"animate-spin\" color=\"var(--accent)\" />}\r\n                                {chapter.status === 'COMPLETED' && <CheckCircle2 size={14} color=\"var(--success)\" />}\r\n                            </div>\r\n\r\n                            {/* Paragraphs List */}\r\n                            {expandedChapters.has(chapter.id) && chapter.structure && (\r\n                                <div style={{ paddingLeft: '2rem', marginTop: '0.2rem', display: 'flex', flexDirection: 'column', gap: '2px' }}>\r\n                                    {chapter.structure.map((para, idx) => (\r\n                                        <div key={idx}\r\n                                            style={{\r\n                                                fontSize: '0.8rem',\r\n                                                color: 'var(--text-muted)',\r\n                                                padding: '4px 8px',\r\n                                                borderLeft: '1px solid var(--glass-border)',\r\n                                                cursor: 'pointer'\r\n                                            }}\r\n                                            className=\"hover:text-white transition-colors\"\r\n                                            onClick={(e) => {\r\n                                                e.stopPropagation();\r\n                                                setSelectedChapterId(chapter.id);\r\n                                                // Future: Scroll to paragraph or insert into editor\r\n                                            }}\r\n                                        >\r\n                                            {para.title || `Paragrafo ${idx + 1}`}\r\n                                        </div>\r\n                                    ))}\r\n                                </div>\r\n                            )}\r\n                        </div>\r\n                    ))}\r\n                </div>\r\n\r\n                <div style={{ padding: '1rem', borderTop: '1px solid var(--glass-border)' }}>\r\n                    <button onClick={generateAll} disabled={globalGenerating} className=\"btn-primary\" style={{ width: '100%', fontSize: '0.9rem' }}>\r\n                        <Play size={14} /> {globalGenerating ? 'Generazione...' : 'Genera Tutto'}\r\n                    </button>\r\n                </div>\r\n            </div>\r\n\r\n            {/* EDITOR / PREVIEW PANEL */}\r\n            <div className=\"glass-panel\" style={{ height: '90vh', display: 'flex', flexDirection: 'column', overflow: 'hidden' }}>\r\n                <div style={{ padding: '1rem 1.5rem', borderBottom: '1px solid var(--glass-border)', display: 'flex', justifyContent: 'space-between', alignItems: 'center' }}>\r\n                    <div style={{ display: 'flex', alignItems: 'center', gap: '0.5rem' }}>\r\n                        <FileText size={18} color=\"var(--accent)\" />\r\n                        <h2 style={{ fontSize: '1.2rem', fontWeight: 600 }}>{currentChapter?.title || \"Seleziona un capitolo\"}</h2>\r\n                    </div>\r\n\r\n                    <div style={{ display: 'flex', gap: '0.5rem' }}>\r\n                        {!isEditing ? (\r\n                            <button onClick={() => setIsEditing(true)} className=\"btn-secondary\" style={{ fontSize: '0.85rem', padding: '0.4rem 0.8rem' }}>\r\n                                <Edit3 size={14} /> Modifica\r\n                            </button>\r\n                        ) : (\r\n                            <button onClick={saveContent} disabled={saving} className=\"btn-success\" style={{ fontSize: '0.85rem', padding: '0.4rem 0.8rem', background: 'var(--success)', border: 'none' }}>\r\n                                {saving ? <Loader2 size={14} className=\"animate-spin\" /> : <><Save size={14} /> Salva</>}\r\n                            </button>\r\n                        )}\r\n                        <button onClick={() => currentChapter && generateChapter(currentChapter.id)} disabled={currentChapter?.status === 'GENERATING'} className=\"btn-primary\" style={{ fontSize: '0.85rem', padding: '0.4rem 0.8rem' }}>\r\n                            <Play size={14} /> Rigenera\r\n                        </button>\r\n                    </div>\r\n                </div>\r\n\r\n                <div style={{ flex: 1, overflowY: 'auto', background: 'rgba(15, 23, 42, 0.5)', position: 'relative' }}>\r\n                    {currentChapter ? (\r\n                        currentChapter.status === 'GENERATING' && !currentChapter.content ? (\r\n                            <div style={{ display: 'flex', flexDirection: 'column', alignItems: 'center', justifyContent: 'center', height: '100%', color: 'var(--text-muted)' }}>\r\n                                <Loader2 size={40} className=\"animate-spin\" style={{ marginBottom: '1rem', opacity: 0.5 }} />\r\n                                <p>L'IA sta scrivendo questo capitolo...</p>\r\n                            </div>\r\n                        ) : (\r\n                            isEditing ? (\r\n                                <textarea\r\n                                    value={editorContent}\r\n                                    onChange={(e) => setEditorContent(e.target.value)}\r\n                                    style={{\r\n                                        width: '100%',\r\n                                        height: '100%',\r\n                                        background: 'transparent',\r\n                                        color: '#e2e8f0',\r\n                                        border: 'none',\r\n                                        outline: 'none',\r\n                                        padding: '2rem',\r\n                                        fontSize: '1.1rem',\r\n                                        lineHeight: '1.8',\r\n                                        fontFamily: 'Merriweather, serif',\r\n                                        resize: 'none'\r\n                                    }}\r\n                                    placeholder=\"Scrivi qui il contenuto del capitolo...\"\r\n                                />\r\n                            ) : (\r\n                                <div\r\n                                    className=\"markdown-content\"\r\n                                    style={{ padding: '2rem', maxWidth: '800px', margin: '0 auto', fontFamily: 'Merriweather, serif' }}\r\n                                    dangerouslySetInnerHTML={{ __html: marked.parse(editorContent || currentChapter.content || \"_Nessun contenuto_\") as string }}\r\n                                />\r\n                            )\r\n                        )\r\n                    ) : (\r\n                        <div style={{ display: 'flex', alignItems: 'center', justifyContent: 'center', height: '100%', color: 'var(--text-muted)' }}>\r\n                            <p>Seleziona un capitolo dall'indice per iniziare.</p>\r\n                        </div>\r\n                    )}\r\n                </div>\r\n            </div>\r\n        </div>\r\n    );\r\n};\r\n\r\nexport default ProductionPage;","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\genco\\Desktop\\lavoro\\w4uN8N\\src\\types.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\genco\\Desktop\\lavoro\\w4uN8N\\src\\utils\\prompt-engine.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]}]
